<!DOCTYPE html>
<!-- This is an autogenerated file - DO NOT EDIT DIRECTLY -->
<!-- This file was generated on Sun Mar 14 2021 14:01:38 GMT-0700 (Pacific Daylight Time) via the forge in willcarh.art v2.1.0-->
<!-- Learn more: https://github.com/wcarhart/willcarh.art -->
<!-- THIS IS A DEVELOPMENT BUILD, PROCEED WITH CAUTION! -->
<html lang="en">
	<head>
		<!-- metadata -->
		<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>willcarh.art</title>
<meta name="description" content="A Case for Git Filters" />
<meta name="twitter:card" value="summary" />
<meta property="og:name" content="willcarh.art" />
<meta property="og:url" content="https://willcarh.art/blog/a-case-for-git-filters" />
<meta property="og:image" content="../../ico/android-chrome-512x512.png" />
<meta property="og:type" content="website" />
<meta property="og:description" content="A Case for Git Filters" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="willcarh.art" />

		<!-- CSS -->
		<link rel="stylesheet" href="../../css/common.css">
		<link rel="stylesheet" href="../../css/logo.css">
		<link rel="stylesheet" href="../../css/darkmode.css">
		<link rel="stylesheet" href="../../css/fancylink.css">
		<link rel="stylesheet" href="../../css/linkicons.css">
		<link rel="stylesheet" href="../../css/list.css">
		<link rel="stylesheet" href="../../css/markdown.css">
		<link rel="stylesheet" href="../../css/credits.css">
		<link rel="stylesheet" href="../../css/blog_specific.css">

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

		<!-- Bootstrap CDN -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

		<!-- icons -->
		<link rel="apple-touch-icon" sizes="180x180" href="../../ico/apple-touch-icon.png">
	    <link rel="icon" type="image/png" sizes="32x32" href="../../ico/favicon-32x32.png">
	    <link rel="icon" type="image/png" sizes="16x16" href="../../ico/favicon-16x16.png">
	    <link rel="manifest" href="../../ico/site.webmanifest">

	    <!-- FontAwesome -->
	    <script src="https://use.fontawesome.com/releases/v5.5.0/js/all.js"></script>

		<!-- animate.css -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

		<!-- site analytics -->
		<script async defer data-domain="willcarh.art" src="https://plausible.io/js/plausible.js"></script>

		<!-- willcarh.art scripts -->
		<script src="../js/darkmode.js"></script>
		<script src="../js/year.js"></script>
		<script src="../js/epochtime.js"></script>
		<script src="../js/readtime.js"></script>
		<script src="../js/blognav.js"></script>
	</head>
	<body>
		<!-- text content -->
		<div id="content-main">
			<div class="spacer"></div>
			<div id="content-body">
				<div id="word-count" class="hidden-tidbit">1508</div>
<div id="read-time" class="hidden-tidbit">8 min read</div>
<div id="next-blog-link" class="hidden-tidbit">recreating-pythons-argparse-in-bash</div>
<div id="blog-title-container" class="animate__animated animated_faster animate__fadeInUp animate__delay-1s">
	<h1 id="blog-title">A Case for Git Filters</h1>
	<h3 id="blog-subtitle">Becoming a git sudoer</h3>
</div>
<div id="blog-credits" class="animate__animated animated_faster animate__fadeInUp animate__delay-2s">
	<div class="row justify-content-center">
		<div id="blog-author-img-container">
			<img id="blog-author-img" alt="author profile image" src="https://storage.googleapis.com/willcarh-art/img/profile.jpg">
		</div>
		<div id="blog-credits-details">
			<h5 id="blog-author">Will Carhart</h5>
			<p class="blog-metadata epochtime-hover">Published on July 7th, 2020 at 4:15 PM PDT</p>
			<p class="blog-metadata epochtime-hover"></p>
			<p class="blog-metadata readtime-hover"><span class="color">8 min read</span></p>
		</div>
	</div>
</div>
<div id="blog-cover-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<img id="blog-cover" alt="A Case for Git Filters cover image" src="https://storage.googleapis.com/willcarh-art/img/blog/a-case-for-git-filters/cover.jpg">
</div>

<div id="blog-content-container" class="blog-border animate__animated animated_faster animate__fadeIn animate__delay-4s">
    <h4 class="content-subtitle">Git's lesser known features</h4><p class="content-text">I'm starting to realize that every time I want to do something in Git that someone else has already written functionality for it. A quick web search shows some lesser known features like <a class="fancy-link" href="https://git-scm.com/docs/git-stash" target="_blank"><code class="inline-code">git stash</code></a> and <a class="fancy-link" href="https://git-scm.com/docs/git-cherry-pick" target="_blank"><code class="inline-code">git cherry-pick</code></a>. But, what if I only want to commit a few lines of the code I've written in a file? Yes, feature already exists, use <a class="fancy-link" href="https://git-scm.com/docs/git-add#Documentation/git-add.txt---patch" target="_blank"><code class="inline-code">git add -p</code></a>. Okay, but what if I found a bug in my current branch and don't know how to find what commit created it? Yes, feature already exists, use <a class="fancy-link" href="https://git-scm.com/docs/git-bisect" target="_blank"><code class="inline-code">git bisect</code></a>. Since its birth in 2005, Git has become one of the most pleasant, fully-featured software tools I use day-to-day (when it does what I want). Let's look at one of the most powerful, underutilized Git features: Git filters.</p><br><h4 class="content-subtitle">Git filters</h4><p class="content-text">Git filters are not a mainstream feature of Git - there's not even a dedicated page for them in the documentation. They're a subfeature of Git Attributes, or the path-specific Git Settings, specified in <code class="inline-code">.gitattributes</code>. You can use a <code class="inline-code">.gitattributes</code> file in your repository to change the settings for a specific repository and not Git as a whole on your machine. If you've used a <code class="inline-code">.gitattributes</code> file in the past, perhaps you've used it to specify merge strategies, which is a commonly used feature. You can explore all of the available Git customizations and functionality in <a class="fancy-link" href="https://git-scm.com/book/en/v2/Customizing-Git-Git-Attributes" target="_blank">the documentation</a>.</p><p class="content-text">For today, we're going to talk about Git filters - or <i>keyword expansion</i> as it's referenced in the docs. When you commit a file to Git, the file contents are <b class="bold-text">immutable</b>, meaning we cannot change the file contents without changing the commit's hash (the commit's unique identifier). If you change the contents of the file, you get a new hash, and need to create a new commit. You can try this yourself on the command line with <code class="inline-code">git hash-object</code>.</p><pre class="code-container"><code class="block-code">echo 'Hello, Git!' | git hash-object --stdin</code></pre><div class="shoutout">
	<p class="shoutout-title"><b>Read more</b></p>
	<p class="shoutout-text">If you're interested in learning more about Git's hashing algorithm <code class="inline-code">SHA-1</code>, <a class="fancy-link" href="https://www.youtube.com/watch?v=4XpnKHJAok8&t=3376s" target="_blank">have a listen from Linus Torvalds himself</a>. Git plans on transitioning to <code class="inline-code">SHA-256</code> in the future after security vulnerabilities have been <a class="fancy-link" href="https://shattered.io/" target="_blank">discovered in <code class="inline-code">SHA-1</code></a>.</p>
</div><br><p class="content-text">These hashes are what uniquely identify each commit, and so they can't be changed once blobs are committed. This can cause problems if we're not careful. Suppose I've written a super cool web application called <b class="bold-text">MyCoolApp</b>, which reads from a database. Suppose in my code somewhere I have the following lines.</p><pre class="code-container"><code class="block-code">const DBNAME = 'MyCoolApp_DB'<br>const DBPASS = 'pA&#36;&#36;w0rD'</code></pre><p class="content-text">MyCoolApp will need these credentials in order to function. However, if we check this file into Git as is, our database credentials will be hardcoded for all to see. This isn't ideal if we want to share our novel code for MyCoolApp without sharing the database credentials.</p><p class="content-text">One way to avoid this is by using <a class="fancy-link" href="https://askubuntu.com/questions/58814/how-do-i-add-environment-variables/58826#58826" target="_blank">environment variables</a>, which is what many deployments use. If you've ever used a CI or PaaS provider, they almost always have a section for adding environment variables. Such is a great way for deploying the application, but it comes with one caveat - where do you put the actual <i>plaintext</i> value after its read into an environment variable? What if you set <code class="inline-code">export DBPASS='pA&#36;&#36;w0rD'</code> but then restart your shell? Yes, there are ways to make this variable persistent, but there's another answer: Git keyword expansion, or <b class="bold-text">Git filters</b>.</p><p class="content-text">At a high level, Git filters allow us to perform <code class="inline-code">sed</code>-like text substitution in a step between the <i>staging area</i> and the <i>working repository</i>. Recall that there are 3 main settings in which code can reside in a local Git repository: the working area (the <i>workspace</i>), the staging area (the <i>index</i>), and repository area (the <i>local repository</i>). There is also the <a class="fancy-link" href="https://git-scm.com/docs/git-stash" target="_blank"><i>stash</i></a>, but that's not relevant for now. To move files from the <i>workspace</i> to the <i>index</i>, we use the command <code class="inline-code">git add</code>. To move files from the <i>index</i> to the <i>local repository</i>, we use the command <code class="inline-code">git commit</code>. Finally, to move files from the <i>local repository</i> to the <i>remote repository</i>, we use the command <code class="inline-code">git push</code>.</p><p class="content-text">Git filters allow us to run some text substitution before files get moved from the <i>index</i> to the <i>local repository</i> (i.e. after <code class="inline-code">git add</code> and before <code class="inline-code">git push</code>). There are two main filters: <code class="inline-code">smudge</code> and <code class="inline-code">clean</code> (you can also define your own custom filters). <code class="inline-code">smudge</code> is run on checkout, and <code class="inline-code">clean</code> is run when files are staged. You can infer the function of <code class="inline-code">smudge</code> and <code class="inline-code">clean</code> based on their definitions in English; we <i>smudge</i> a secret value before we check it out, and we <i>clean</i> it before we check it back in.</p><img class="content-img" alt="Diagram of smudge filter" src="https://storage.googleapis.com/willcarh-art/img/blog/a-case-for-git-filters/smudge.png"><p class="img-subtitle">The <code class="inline-code">smudge</code> filter is run at checkout.</p><img class="content-img" alt="Diagram of clean filter" src="https://storage.googleapis.com/willcarh-art/img/blog/a-case-for-git-filters/clean.png"><p class="img-subtitle">The <code class="inline-code">clean</code> filter is run when files are staged.</p><p class="content-text">These filters can be configured to do just about anything, which makes them super powerful. Another great use case is using them to resolve Windows vs. Unix line endings on file checkout if you develop on both Windows and Linux-like machines. For now, let's see how we can use Git filters to resolve our credentials issue from above.</p><br><h4 class="content-subtitle">A simple use case</h4><p class="content-text">We're going to use <code class="inline-code">smudge</code> and <code class="inline-code">clean</code> to hide our secret values (i.e. our <code class="inline-code">DBPASS</code>) from Git, so when someone views our repository on GitHub they can't access our production database.</p><p class="content-text">First, let's make a dummy repository for demonstration purposes.</p><pre class="code-container"><code class="block-code">mkdir ~/MyCoolApp<br>cd !&#36;<br>git init</code></pre><p class="content-text">Next, let's add our secret text to a dummy file. In an actual application, you'd have much more code than just two variables.</p><pre class="code-container"><code class="block-code">echo -e 'const DBNAME = "MyCoolApp_DB"\nconst DBPASS = "pA&#36;&#36;w0rD"' &gt; app.js</code></pre><p class="content-text">We can print the contents of <code class="inline-code">app.js</code> to confirm that we see our correct, plaintext credentials.</p><pre class="code-container"><code class="block-code">cat app.js</code></pre><pre class="code-container"><code class="block-code">const DBNAME = 'MyCoolApp_DB'<br>const DBPASS = 'pA&#36;&#36;w0rD'</code></pre><p class="content-text">Should we commit <code class="inline-code">app.js</code> right now, <code class="inline-code">pA&#36;&#36;w0rD</code> will forever be written to the repository's history, which is not good. Let's configure our <code class="inline-code">smudge</code> and <code class="inline-code">clean</code> filters to avoid this undesired result.</p><p class="content-text">There are two places you can define your Git filters, either in <code class="inline-code">.git/config</code> or <code class="inline-code">~/.gitconfig</code>. Putting your filters in <code class="inline-code">.git/config</code> means the filter is defined for this repository only, but they may be visible in your remote. Putting your filters in <code class="inline-code">~/.gitconfig</code> means the filter is defined for all Git repositories on this machine. Let's use latter, because we want to be sure we don't expose our sensitive credentials. To do, we'll need to make sure we use the <code class="inline-code">--global</code> flag when we configure our filters.</p><p class="content-text">Let's create a new filter called <code class="inline-code">resolveSecret</code>. We'll use <code class="inline-code">sed</code> for the actual string manipulation.</p><pre class="code-container"><code class="block-code">git config --global filter.resolveSecret.smudge "sed 's/SMUDGED_DATABASE_PASSWORD/pA&#36;&#36;w0rD/g'"<br>git config --global filter.resolveSecret.clean "sed 's/pA&#36;&#36;w0rD/SMUDGED_DATABASE_PASSWORD/g'"</code></pre><p class="content-text">Next, let's wire up our filter to be used in MyCoolApp's local repository.</p><pre class="code-container"><code class="block-code">echo 'app.js filter=resolveSecret' &gt; .gitattributes</code></pre><p class="content-text">We can confirm that our filter <code class="inline-code">resolveSecret</code> is properly defined in <code class="inline-code">~/.gitconfig</code>.</p><pre class="code-container"><code class="block-code">cat ~/.gitconfig</code></pre><pre class="code-container"><code class="block-code">...<br>[filter "resolveSecret"]<br>    clean = sed 's/pA&#36;&#36;w0rD/SMUDGED_DATABASE_PASSWORD/g'<br>    smudge = sed 's/SMUDGED_DATABASE_PASSWORD/pA&#36;&#36;w0rD/g'</code></pre><p class="content-text">And, we can confirm that <code class="inline-code">resolveSecret</code> will be run on staging and checking out of <code class="inline-code">app.js</code>.</p><pre class="code-container"><code class="block-code">cat .gitattributes</code></pre><pre class="code-container"><code class="block-code">app.js filter=resolveSecret</code></pre><div class="shoutout">
	<p class="shoutout-title"><b>Watch Out!</b></p>
	<p class="shoutout-text">If we don't use the <code class="inline-code">--global</code> flag when defining our filter, then Git will put it in the <code class="inline-code">.git/config</code> for the current repository. Although you can't see this in GitHub's UI, the secret value is still included in the repository, so a nefarious individual could expose it!</p>
</div><br><p class="content-text">Next, we can commit our files normally.</p><pre class="code-container"><code class="block-code">git status<br>git add -A<br>git commit -m 'Initial commit'</code></pre><p class="content-text">We can create a new remote repository on GitHub using the <a class="fancy-link" href="https://github.com/cli/cli" target="_blank">GitHub CLI <code class="inline-code">gh</code></a>. If you don't use <code class="inline-code">gh</code>, you can either make a repository manually or install it with <code class="inline-code">brew install gh</code>. The following snippet assumes your local username is the same as your GitHub username.</p><pre class="code-container"><code class="block-code"># create the remote<br>gh repo create --public &#36;(basename "&#36;(pwd)")<br><br># confirm it added remote 'origin' to our local repository<br>git remote --verbose<br><br># gh sets up remotes using HTTPS, if we want to use SSH we'll have to reconfigure 'origin'<br>git remote rm origin<br>git remote add origin git@github.com:&#36;(whoami)/&#36;(basename "&#36;(pwd)").git<br>git remote --verbose<br><br># push to remote<br>git push -u origin master<br><br># open remote in browser<br>if [[ "&#36;(uname -s)" == 'Darwin' ]] ; then open "https://github.com/&#36;(whoami)/&#36;(basename "&#36;(pwd)")" ; fi</code></pre><p class="content-text">If we navigate to our remote repository in the browser, we'll see the string <code class="inline-code">SMUDGED_DATABASE_PASSWORD</code> instead of our plaintext password. Pretty cool!</p><p class="content-text">There are a few caveats to be aware of. If we change our password or secret value in our code text, we'll also need to update our Git filter before we commit. In addition, this filter will only work on machines that have the filter configured correctly. If you push from a machine with the filter configured and pull from a different machine without the filter configured, you'll be stuck with the smudged string instead of the plaintext one.</p><br><h4 class="content-subtitle">Conclusion</h4><p class="content-text">The <code class="inline-code">smudge</code> and <code class="inline-code">clean</code> filters are powerful. This is one cool example of their usage, but because you can run arbitrary code from within the filter, you can do just about anything. Perhaps you'd like to set up a server to receive pings whenever someone pulls from your repository and then send a push notification to your phone. Although a bit extra, this is definitely possible with Git filters. I'll leave the rest of that implementation to you.</p><p class="content-text">If you'd like a complete copy of the code developed in this post, check out <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-snippets/blob/master/a-case-for-git-filters/snippet.bash" target="_blank">this repository</a>.</p><br><p class="content-text centered-text">🦉</p>
</div>
<div class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<p id="cover-credit">Artwork by <a class="fancy-link" href="https://stock.adobe.com/contributor/208403499/svetlana" target="_blank">Svetlana</a></p>
</div>
<div id="blog-navigation-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<div class="row">
		<div class="col-md-1"></div>
		<div id="blog-navigation-back" class="col-md-4 blog-navigation-chunk">
			<h3><span class="show-more">⟵</span> Back</h3>
			<p class="navigation-detail-text content-text">Go back to the blog</p>
		</div>
		<div class="col-md-2"></div>
		<div id="blog-navigation-next" class="col-md-4 blog-navigation-chunk">
			<h3>Read More <span class="show-more">⟶</span></h3>
			<p class="navigation-detail-text content-text">Recreating Python's argparse in Bash</p>
		</div>
		<div class="col-md-1"></div>
	</div>
</div>
<div class="spacer-small"></div>
			</div>
			<div class="spacer"></div>

			<div id="credits" class="row">
	<a id="footer-github-icon" href="https://github.com/wcarhart" target="_blank"><i class="fab fa-github"></i></a>
	<a id="footer-stackoverflow-icon" href="https://stackoverflow.com/users/6246128/wcarhart" target="_blank"><i class="fab fa-stack-overflow" data-fa-transform="left-2"></i></a>
	<a id="footer-linkedin-icon" href="https://linkedin.com/in/willcarhart" target="_blank"><i class="fab fa-linkedin" data-fa-transform="left-2"></i></a>
	<a id="footer-facebook-icon" href="../blog/why-i-deleted-my-facebook.html"><i class="fab fa-facebook-f" data-fa-transform="left-4"></i></a>
	<div style="text-align:center"><a class="fancy-link" href="../etc.html#license">&copy;&nbsp; Will Carhart <span id="year"></span></a></div>
</div>
			<div class="spacer-small"></div>
		</div>

		<!-- logo -->
		<a id="logo-container" href="../../index.html">
	<img id="logo" alt="willcarh.art logo" src="../../ico/android-chrome-512x512.png">
</a>

		<!-- dark mode toggle -->
		<div id="dark-mode-toggle-container">
	<button id="dark-mode-toggle"></button>
</div>
	</body>
</html>