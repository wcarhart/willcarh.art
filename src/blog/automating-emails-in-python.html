<!DOCTYPE html>
<!-- This is an autogenerated file - DO NOT EDIT DIRECTLY -->
<!-- This file was generated on Sun Mar 14 2021 14:20:09 GMT-0700 (Pacific Daylight Time) via the forge in willcarh.art v2.1.0-->
<!-- Learn more: https://github.com/wcarhart/willcarh.art -->
<!-- THIS IS A DEVELOPMENT BUILD, PROCEED WITH CAUTION! -->
<html lang="en">
	<head>
		<!-- metadata -->
		<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>willcarh.art</title>
<meta name="description" content="Automating Emails in Python" />
<meta name="twitter:card" value="summary" />
<meta property="og:name" content="willcarh.art" />
<meta property="og:url" content="https://willcarh.art/blog/automating-emails-in-python" />
<meta property="og:image" content="../../ico/android-chrome-512x512.png" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Automating Emails in Python" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="willcarh.art" />

		<!-- CSS -->
		<link rel="stylesheet" href="../../css/common.css">
		<link rel="stylesheet" href="../../css/logo.css">
		<link rel="stylesheet" href="../../css/darkmode.css">
		<link rel="stylesheet" href="../../css/fancylink.css">
		<link rel="stylesheet" href="../../css/linkicons.css">
		<link rel="stylesheet" href="../../css/list.css">
		<link rel="stylesheet" href="../../css/markdown.css">
		<link rel="stylesheet" href="../../css/credits.css">
		<link rel="stylesheet" href="../../css/blog_specific.css">

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

		<!-- Bootstrap CDN -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

		<!-- icons -->
		<link rel="apple-touch-icon" sizes="180x180" href="../../ico/apple-touch-icon.png">
	    <link rel="icon" type="image/png" sizes="32x32" href="../../ico/favicon-32x32.png">
	    <link rel="icon" type="image/png" sizes="16x16" href="../../ico/favicon-16x16.png">
	    <link rel="manifest" href="../../ico/site.webmanifest">

	    <!-- FontAwesome -->
	    <script src="https://use.fontawesome.com/releases/v5.5.0/js/all.js"></script>

		<!-- animate.css -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

		<!-- site analytics -->
		<script async defer data-domain="willcarh.art" src="https://plausible.io/js/plausible.js"></script>

		<!-- willcarh.art scripts -->
		<script src="../js/darkmode.js"></script>
		<script src="../js/year.js"></script>
		<script src="../js/epochtime.js"></script>
		<script src="../js/readtime.js"></script>
		<script src="../js/blognav.js"></script>
	</head>
	<body>
		<!-- text content -->
		<div id="content-main">
			<div class="spacer"></div>
			<div id="content-body">
				<div id="word-count" class="hidden-tidbit">1698</div>
<div id="read-time" class="hidden-tidbit">9 min read</div>
<div id="next-blog-link" class="hidden-tidbit">the-power-of-introspection-in-python</div>
<div id="blog-title-container" class="animate__animated animated_faster animate__fadeInUp animate__delay-1s">
	<h1 id="blog-title">Automating Emails in Python</h1>
	<h3 id="blog-subtitle">Why Gmail sometimes says no</h3>
</div>
<div id="blog-credits" class="animate__animated animated_faster animate__fadeInUp animate__delay-2s">
	<div class="row justify-content-center">
		<div id="blog-author-img-container">
			<img id="blog-author-img" alt="author profile image" src="https://storage.googleapis.com/willcarh-art/img/profile.jpg">
		</div>
		<div id="blog-credits-details">
			<h5 id="blog-author">Will Carhart</h5>
			<p class="blog-metadata epochtime-hover">Published on July 29th, 2019 at 10:48 PM PDT</p>
			<p class="blog-metadata epochtime-hover">Updated on November 28th, 2020 at 5:33 PM PST</p>
			<p class="blog-metadata readtime-hover"><span class="color">9 min read</span></p>
		</div>
	</div>
</div>
<div id="blog-cover-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<img id="blog-cover" alt="Automating Emails in Python cover image" src="https://storage.googleapis.com/willcarh-art/img/blog/automating-emails-in-python/cover.png">
</div>
<div id="stale-content-container" class="blog-border animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<h4 class="stale-content-title">Pardon the Interruption</h4>
	<p class="content-text">This blog post was written under a previous major version of <a class="fancy-link" href="../../index.html">willcarh.art</a> (e.g. <code class="inline-code">v1.x</code> vs. <code class="inline-code">v2.x</code>). This may seem trivial, but because some of my blog posts reference the website's code, links and code snippets may no longer be valid. Thank you for understanding and please enjoy the post!</p>
</div>
<div id="blog-content-container" class="blog-border animate__animated animated_faster animate__fadeIn animate__delay-4s">
    <h4 class="content-subtitle">Emails in Python: An Introduction</h4><p class="content-text">Ever want to set up an email newsletter on your own? Or have you ever wondered how services like <a class="fancy-link" href="https://mailchimp.com/" target="_blank">MailChimp</a> send automated emails? Sending emails programmatically is very common practice, and Python comes out of the box with some awesome packages to help us send emails. Let's dive in!</p><div class="shoutout">
	<p class="shoutout-title"><b>Note</b></p>
	<p class="shoutout-text">You can download all the demo code from this blog post <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-snippets/blob/master/automating-emails-in-python/snippet.py" target="_blank">here</a>.</p>
</div><br><br><h4 class="content-subtitle">What is SMTP?</h4><p class="content-text">The <a class="fancy-link" href="https://www.geeksforgeeks.org/simple-mail-transfer-protocol-smtp/" target="_blank">Simple Mail Transfer Protocol</a>, or <i>SMTP</i>, is one of the most common protocols for sending outgoing emails. SMTP servers are responsible for connecting individual email clients like Gmail and Yahoo to the greater Internet, which in turn allows you to send an email to (almost) anyone in the world! I'm not going to delve into the details of SMTP right now, but a high-level take away is that <b class="bold-text">SMTP is an interface that allows you to send emails to other recipients' inboxes.</b></p><br><h4 class="content-subtitle">Using the <code class="inline-code">smtplib</code> package in Python</h4><p class="content-text">Python has a powerful vanilla package for sending emails: <code class="inline-code">smtplib</code>. This package abstracts away a lot of the heavily lifting from the user and exposes a simple API. Let's look at some quick examples.</p><p class="content-text">Let's suppose I'd like to send an email, via Python, from my super cool email address <i>pythonista@gmail.com</i>, where my very secure password is simply <i>password</i>. Gmail actually won't like this method, but let's disregard that for now.</p><pre class="code-container"><code class="block-code">import smtplib, ssl<br>from email.mime.text import MIMEText<br><br>port = 465<br>smtp_server = 'smtp.gmail.com'<br><br>email_content = "Hi! How's it going?"<br>sender = 'pythonista@gmail.com'<br>password = 'password'<br>receiver = 'receiver@gmail.com'<br>subject = 'Just checking in!'<br>message = MIMEText(email_content)<br>message['to'] = receiver<br>message['from'] = sender<br>message['subject'] = subject<br><br>context = ssl.create_default_context()<br>with smtplib.SMTP_SSL(smtp_server, port, context=context) as server:<br>    server.login(sender, password)<br>    server.sendmail(sender, receiver, message.as_string())</code></pre><p class="content-text">This is just a simple example - Python can do a <i>lot</i> more when it comes to emails! I'm not going to dive into all of its features, but there are plenty of great tutorials for learning how to send emails with Python, such as over at <a class="fancy-link" href="https://realpython.com/python-send-email/" target="_blank">RealPython</a>.</p><br><h4 class="content-subtitle">Let's talk security</h4><p class="content-text">Before we go any further, let's take a look at a specific snippet from the code above:</p><pre class="code-container"><code class="block-code">context = ssl.create_default_context()<br>with smtplib.SMTP_SSL(smtp_server, port, context=context) as server:<br>    ...</code></pre><p class="content-text">What do the lines <code class="inline-code">ssl.create_default_context()</code> and <code class="inline-code">smtplib.SMTP_SSL()</code> do? In order to set up a secure connection for sending our emails, we use <a class="fancy-link" href="https://www.websecurity.symantec.com/security-topics/what-is-ssl-tls-https" target="_blank">SSL</a>, which is a transport security layer protocol. This encrypts our messages and protects us from nefarious individuals who might be trying to read them without our knowledge! Security is something that Gmail takes very seriously, and if we want to send emails through an <i>@gmail</i> address, we'll have to make sure we're following the proper protocols.</p><br><h4 class="content-subtitle">Insert Gmail</h4><p class="content-text">Remember earlier when I said that Gmail won't let us send emails through an <i>@gmail</i> address normally? This is because doing so allows <i>less secure</i> applications to access our Gmail address. Anyone who knows our password could write some code to send malicious emails through <i>pythonista@gmail.com</i>, which is very bad!</p><br><p class="content-text">In order for us to send emails with the above code snippet, we'd have to go into a <a class="fancy-link" href="https://support.google.com/accounts/answer/6010255?hl=en" target="_blank">hidden Gmail setting</a> and turn off protections which prevent sending emails from insecure applications. This will allow us to send emails freely with the code we've already written, but Gmail often complains! The email utility I wrote for <a class="fancy-link" href="../../index.html">willcarh.art</a>, the <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-v1/blob/master/herald.py" target="_blank">Herald</a>, used this implementation for the site's initial architecture. However, whenever someone would send an email through the site, I'd get a <b class="bold-text">critical security alert</b> from Google, claiming that <i>"Someone just used your password to try to sign in to your account. Google blocked them, but you should check what happened!"</i></p><p class="content-text"><b class="bold-text">Yes, Google, that was me.</b></p><img class="content-img" alt="Picture of Google critical security alert" src="https://storage.googleapis.com/willcarh-art/img/blog/automating-emails-in-python/criticalalert.png"><p class="img-subtitle">What the Google Security Alert looks like</p><p class="content-text">What's troublesome is not the annoying email itself, but Gmail's behavior: <i>it locked out my application until I manually confirmed its access.</i> This can't be a valid implementation, because then nobody can send emails from <a class="fancy-link" href="../../index.html">willcarh.art</a> while Gmail has it blocked! How do we get around this?</p><br><h4 class="content-subtitle">Our saving grace: the official Gmail API</h4><p class="content-text">In order to allow secure applications to send automated emails, Gmail exposes an API that helps ensure that automated email access is intended. And, it's got some <i>"decent"</i> <a class="fancy-link" href="https://developers.google.com/gmail/api/quickstart/python" target="_blank">documentation</a> for how to get started. Let's take a look at the quickstart Python guide in Gmail's API docs. I've modified it a little bit to simplify it for us. First, let's install the necessary dependencies with <code class="inline-code">pip</code>.</p><pre class="code-container"><code class="block-code">pip install --upgrade google-api-python-client google-auth-httplib2 google-auth-oauthlib</code></pre><p class="content-text">Next, go ahead and click the <b class="bold-text">Enable the Gmail API</b> button from the documentation to acquire your Gmail API keys. Save this file as <code class="inline-code">credentials.json</code>.</p><p class="content-text">Then, let's write a simple script to set up our credentials.</p><pre class="code-container"><code class="block-code">import os<br>import pickle<br>from googleapiclient.discovery import build<br>from google_auth_oauthlib.flow import InstalledAppFlow<br>from google.auth.transport.requests import Request<br><br>SCOPES = ['https://www.googleapis.com/auth/gmail.send']<br><br>def main():<br>    creds = None<br>    # The file token.pickle stores the user's access and refresh tokens, and is<br>    # created automatically when the authorization flow completes for the first<br>    # time.<br>    if os.path.exists('token.pickle'):<br>        with open('token.pickle', 'rb') as token:<br>            creds = pickle.load(token)<br>    # If there are no (valid) credentials available, let the user log in.<br>    if not creds or not creds.valid:<br>        if creds and creds.expired and creds.refresh_token:<br>            creds.refresh(Request())<br>        else:<br>            flow = InstalledAppFlow.from_client_secrets_file('credentials.json', SCOPES)<br>            creds = flow.run_local_server(port=0)<br>        # Save the credentials for the next run<br>        with open('token.pickle', 'wb') as token:<br>            pickle.dump(creds, token)<br><br>    service = build('gmail', 'v1', credentials=creds)</code></pre><p class="content-text">When we run this script, it'll open a browser window and walk you through your API key setup. During the setup, if Gmail states that your app isn't secure, just click the <b class="bold-text">Advanced</b> button to continue past the checkpoint. The good news is once you've run this script once, you just need the <code class="inline-code">token.pickle</code> file that is produced; we can do away with <code class="inline-code">credentials.json</code> and most of our code from above.</p><div class="shoutout">
	<p class="shoutout-title"><b>Watch out!</b></p>
	<p class="shoutout-text">Although <code class="inline-code">token.pickle</code> is a serialized Python object, it is not encrypted! Anyone who has access to this file can open it and extract the contents with Python, so you should <i>not</i> check it into version control!</p>
</div><br><p class="content-text">Pay close attention to this line:</p><pre class="code-container"><code class="block-code">SCOPES = ['https://www.googleapis.com/auth/gmail.send']</code></pre><p class="content-text">This is how Gmail defines the permissions of your application. We have selected the <b class="bold-text">gmail.send</b> permission, but the Gmail API specifies quite a few more. You can read about all of the available authorization scopes <a class="fancy-link" href="https://developers.google.com/gmail/api/auth/scopes" target="_blank">here</a>. A good rule to follow is to only give your application the bare minimum permissions that still allow it to function properly. If you look at the list of authorization scopes available for the Gmail API, you'll see that there are other options that also allow for sending emails, such as <b class="bold-text">gmail.compose</b> and <b class="bold-text">gmail.modify</b>. However, we can minimize the potential security risk of our application by restricting its permissions to only <b class="bold-text">gmail.send</b>.</p><br><h4 class="content-subtitle">Using the Gmail API to send emails</h4><p class="content-text">Great! Now we can write some code to actually send emails! First, let's revise our code from above to be a little bit more succinct.</p><pre class="code-container"><code class="block-code">import os<br>import pickle<br><br>def get_gmail_api_instance():<br>    if not os.path.exists('token.pickle'):<br>        return None<br>    with open('token.pickle', 'rb') as token:<br>        creds = pickle.load(token)<br>    service = build('gmail', 'v1', credentials=creds)<br>    return service</code></pre><p class="content-text">Cool! Now, let's write a quick function to draft an email that the Gmail API will send for us. The Gmail API doesn't work with regular strings, unlike <code class="inline-code">smtplib</code> from earlier. We'll have to use <code class="inline-code">base64</code> encodings.</p><pre class="code-container"><code class="block-code">import base64<br>from email.mime.text import MIMEText<br><br>def create_message(sender, to, subject, message_text):<br>    message = MIMEText(message_text)<br>    message['to'] = to<br>    message['from'] = sender<br>    message['subject'] = subject<br>    raw = base64.urlsafe_b64encode(message.as_bytes())<br>    raw = raw.decode()<br>    body = {'raw': raw}<br>    return body</code></pre><p class="content-text">Nice! Next, we'll write another function for actually sending emails that we've drafted using our code above.</p><pre class="code-container"><code class="block-code">def send_email(service, user_id, message):<br>    try:<br>        message = (service.users().messages().send(userId=user_id, body=message).execute())<br>        return message<br>    except Exception as e:<br>        print("err: problem sending email")<br>        print(e)</code></pre><p class="content-text">Almost there! Finally, we'll write a little bit of code to string everything together!</p><pre class="code-container"><code class="block-code">import sys<br><br># draft our message<br>sender = 'pythonista@gmail.com'<br>receiver = 'receiver@gmail.com'<br>subject = 'Just checking in!'<br>message_text = "Hi! How's it going?"<br><br># authenticate with Gmail API<br>service = get_gmail_api_instance()<br>if service == None:<br>    print("err: no credentials .pickle file found")<br>    sys.exit(1)<br><br># create message structure<br>message = create_message(sender, receiver, subject, message_text)<br><br># send email<br>result = send_email(service, sender, message)<br>if not result == None:<br>    print(f"Message sent successfully! Message id: {result['id']}")</code></pre><p class="content-text">And that's it! Now when we send emails, Gmail won't complain anymore! 🎉</p><br><h4 class="content-subtitle">Parting Notes</h4><p class="content-text">There you have it! You're now a pythonista armed with the power, and responsibility, of Gmail. Note that when you use the Gmail API, you're subject to its Terms of Service, so please don't use it nefariously 😊</p><p class="content-text">If you'd like to use the code from this blog post, I've uploaded it all to a <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-snippets/blob/master/automating-emails-in-python/snippet.py" target="_blank">here</a> for your convenience. Many of the code samples were derived from Gmail's API documentation for Python, which you can access <a class="fancy-link" href="https://developers.google.com/gmail/api/quickstart/python" target="_blank">here</a>.</p><p class="content-text">In addition, I used this architecture for my own email utility, the Herald, for <a class="fancy-link" href="../../index.html">willcarh.art</a>. You can see it in action by going to the <a class="fancy-link" href="../../index.html">contact</a> section of the homepage. If you'd like to take a peek at the <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-v1/blob/master/herald.py" target="_blank">source code</a>, please be my guest!</p><div class="shoutout">
	<p class="shoutout-title"><b>Note</b></p>
	<p class="shoutout-text">In <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-v1" target="_blank">v1 of willcarh.art</a>, email sending was backed by a Django application running on a Heroku dyno. The website no longer sends automated emails, but the code from this blog post is still totally valid!</p>
</div><br><p class="content-text centered-text">🦉</p>
</div>
<div class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<p id="cover-credit">Artwork by <a class="fancy-link" href="https://www.deviantart.com/aaronolive" target="_blank">AaronOlive</a></p>
</div>
<div id="blog-navigation-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<div class="row">
		<div class="col-md-1"></div>
		<div id="blog-navigation-back" class="col-md-4 blog-navigation-chunk">
			<h3><span class="show-more">⟵</span> Back</h3>
			<p class="navigation-detail-text content-text">Go back to the blog</p>
		</div>
		<div class="col-md-2"></div>
		<div id="blog-navigation-next" class="col-md-4 blog-navigation-chunk">
			<h3>Read More <span class="show-more">⟶</span></h3>
			<p class="navigation-detail-text content-text">The Power of Introspection in Python</p>
		</div>
		<div class="col-md-1"></div>
	</div>
</div>
<div class="spacer-small"></div>
			</div>
			<div class="spacer"></div>

			<div id="credits" class="row">
	<a id="footer-github-icon" href="https://github.com/wcarhart" target="_blank"><i class="fab fa-github"></i></a>
	<a id="footer-stackoverflow-icon" href="https://stackoverflow.com/users/6246128/wcarhart" target="_blank"><i class="fab fa-stack-overflow" data-fa-transform="left-2"></i></a>
	<a id="footer-linkedin-icon" href="https://linkedin.com/in/willcarhart" target="_blank"><i class="fab fa-linkedin" data-fa-transform="left-2"></i></a>
	<a id="footer-facebook-icon" href="../blog/why-i-deleted-my-facebook.html"><i class="fab fa-facebook-f" data-fa-transform="left-4"></i></a>
	<div style="text-align:center"><a class="fancy-link" href="../etc.html#license">&copy;&nbsp; Will Carhart <span id="year"></span></a></div>
</div>
			<div class="spacer-small"></div>
		</div>

		<!-- logo -->
		<a id="logo-container" href="../../index.html">
	<img id="logo" alt="willcarh.art logo" src="../../ico/android-chrome-512x512.png">
</a>

		<!-- dark mode toggle -->
		<div id="dark-mode-toggle-container">
	<button id="dark-mode-toggle"></button>
</div>
	</body>
</html>