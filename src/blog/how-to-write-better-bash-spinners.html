<!DOCTYPE html>
<!-- This is an autogenerated file - DO NOT EDIT DIRECTLY -->
<!-- This file was generated on Mon Mar 08 2021 00:27:02 GMT-0800 (Pacific Standard Time) via the forge in willcarh.art v2.0.0-->
<!-- Learn more: https://github.com/wcarhart/willcarh.art -->
<!-- THIS IS A DEVELOPMENT BUILD, PROCEED WITH CAUTION! -->
<html lang="en">
	<head>
		<!-- metadata -->
		<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>willcarh.art</title>
<meta name="description" content="How to Write Better Bash Spinners" />
<meta name="twitter:card" value="summary" />
<meta property="og:name" content="willcarh.art" />
<meta property="og:url" content="https://willcarh.art/blog/how-to-write-better-bash-spinners" />
<meta property="og:image" content="../../ico/android-chrome-512x512.png" />
<meta property="og:type" content="website" />
<meta property="og:description" content="How to Write Better Bash Spinners" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="willcarh.art" />

		<!-- CSS -->
		<link rel="stylesheet" href="../../css/common.css">
		<link rel="stylesheet" href="../../css/logo.css">
		<link rel="stylesheet" href="../../css/darkmode.css">
		<link rel="stylesheet" href="../../css/fancylink.css">
		<link rel="stylesheet" href="../../css/linkicons.css">
		<link rel="stylesheet" href="../../css/list.css">
		<link rel="stylesheet" href="../../css/markdown.css">
		<link rel="stylesheet" href="../../css/credits.css">
		<link rel="stylesheet" href="../../css/blog_specific.css">

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

		<!-- Bootstrap CDN -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

		<!-- icons -->
		<link rel="apple-touch-icon" sizes="180x180" href="../../ico/apple-touch-icon.png">
	    <link rel="icon" type="image/png" sizes="32x32" href="../../ico/favicon-32x32.png">
	    <link rel="icon" type="image/png" sizes="16x16" href="../../ico/favicon-16x16.png">
	    <link rel="manifest" href="../../ico/site.webmanifest">

	    <!-- FontAwesome -->
	    <script src="https://use.fontawesome.com/releases/v5.5.0/js/all.js"></script>

		<!-- animate.css -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

		<!-- site analytics -->
		<script async defer data-domain="willcarh.art" src="https://plausible.io/js/plausible.js"></script>

		<!-- willcarh.art scripts -->
		<script src="../js/darkmode.js"></script>
		<script src="../js/year.js"></script>
		<script src="../js/epochtime.js"></script>
		<script src="../js/readtime.js"></script>
		<script src="../js/blognav.js"></script>
	</head>
	<body>
		<!-- text content -->
		<div id="content-main">
			<div class="spacer"></div>
			<div id="content-body">
				<div id="word-count" class="hidden-tidbit">1621</div>
<div id="read-time" class="hidden-tidbit">9 min read</div>
<div id="next-blog-link" class="hidden-tidbit">spinning-up-a-fleet-of-digitalocean-droplets</div>
<div id="blog-title-container" class="animate__animated animated_faster animate__fadeInUp animate__delay-1s">
	<h1 id="blog-title">How to Write Better Bash Spinners</h1>
	<h3 id="blog-subtitle">Level up your shell scripts</h3>
</div>
<div id="blog-credits" class="animate__animated animated_faster animate__fadeInUp animate__delay-2s">
	<div class="row justify-content-center">
		<div id="blog-author-img-container">
			<img id="blog-author-img" alt="author profile image" src="https://storage.googleapis.com/willcarh-art/img/profile.jpg">
		</div>
		<div id="blog-credits-details">
			<h5 id="blog-author">Will Carhart</h5>
			<p class="blog-metadata epochtime-hover">Published on March 18th, 2020 at 11:25 PM PDT</p>
			<p class="blog-metadata epochtime-hover"></p>
			<p class="blog-metadata readtime-hover"><span class="color">9 min read</span></p>
		</div>
	</div>
</div>
<div id="blog-cover-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<img id="blog-cover" alt="How to Write Better Bash Spinners cover image" src="https://storage.googleapis.com/willcarh-art/img/blog/how-to-write-better-bash-spinners/cover.jpg">
</div>

<div id="blog-content-container" class="blog-border animate__animated animated_faster animate__fadeIn animate__delay-4s">
    <h4 class="content-subtitle">You should be using progress indicators</h4><p class="content-text">Have you ever done a <code class="inline-code">cp -a</code> and then waited five minutes, wondering if your files were still copying? Progress indicators on the command line share the state of your script with the terminal user. It could be anything from copying a file to executing a particularly expensive query, indicating that your script is thinking is a good thing.</p><p class="content-text">One way to do this is to simply log what your script is doing.</p><pre class="code-container"><code class="block-code">echo "Copying the files..."<br>cp -a "$src/*" "$dest"<br>echo "Done!"</code></pre><p class="content-text">Sharing the state of your script with the user via logging what has happened is a great start. However, this doesn't exactly solve the problem, as long running commands can still prevent log statements from occurring while the script is processing.</p><br><h4 class="content-subtitle">A simple spinner</h4><p class="content-text">A simple way around this is a spinner. I'm sure you've seen them on websites. When a resource or asset is loading, a webpage might throw up a spinning wheel or other animation to communicate to the user that the machine is working. Despite this animation not knowing the actual progress of the task, it still provides the user with the comfort that the task has been started.</p><p class="content-text">We can accomplish the same thing on the terminal, where tasks can often take a long time. Let's start with the simplest of spinners.</p><pre class="code-container"><code class="block-code">while :; do for s in / - \\ \|; do printf "\r$s"; sleep .1; done; done</code></pre><p class="content-text">What does this do? Well, <code class="inline-code">while :</code> creates an infinite loop, <code class="inline-code">for s in / - \\ \|</code> iterates over four different characters, and <code class="inline-code">printf "\r$s" ; sleep .1</code> clears the line and prints the next character in the sequence. With a 100ms delay, this creates the animation of a spinner. Go ahead and try running the above command on your terminal to see it in action.</p><p class="content-text">This is pretty cool! We could create an alias to automate this process on the command line.</p><pre class="code-container"><code class="block-code">alias spin='while :; do for s in / - \\ \|; do printf "\r$s"; sleep .1; done; done'</code></pre><p class="content-text">Now, you might think we've solved the problem. We could just do <code class="inline-code">cp -a "$src/*" "$dest" && spin</code> to create a spinner while we run long commands, right? Well, no, at least not yet. When we use our spinner this way, we run it in the same process as our long running command, meaning that our command will have to complete before the spinner even starts.</p><p class="content-text">You might say, why don't we run our spinner in the background? Perhaps we attempt this with <code class="inline-code">&</code>.</p><pre class="code-container"><code class="block-code">spin &<br>cp -a "$src/*" "$dest"</code></pre><p class="content-text">This means our spinner will run in the background while our long running command, <code class="inline-code">cp -a "$src/*" "$dest"</code>, runs. However, there are still a number of other issues. First off, what if our long running command needs to output some information? That would interfere with the spinner's output. In addition, how do we <i>stop</i> the spinner after we've started it? Let's think about how we can modularize our spinner logic to make it a little bit easier to use.</p><br><h4 class="content-subtitle">Adding some modularity</h4><p class="content-text">For starters, let's define some goals for our spinner.</p><ul><li>The spinner should run in the background.</li><li>The spinner should be able to be started and stopped independently.</li><li>The spinner should not interfere with other command line output.</li></ul><p class="content-text">How might we make our spinner accomplish all this? First off, let's handle that background process. We can assign the spinner's process ID, or PID, to a variable using <code class="inline-code">$!</code>. In Bash, <code class="inline-code">$!</code> means the PID of the most recently spawned background process (learn more <a class="fancy-link" href="https://stackoverflow.com/a/5163260/6246128" target="_blank">here</a>). We can use this to store our spinner's PID so we can kill it whenever we need to.</p><pre class="code-container"><code class="block-code">spin &<br>pid=$!<br>...<br>kill -9 $pid</code></pre><p class="content-text">Great! Now we can stop our spinner when we're done with our long running command. However, you may notice that <code class="inline-code">$pid</code> still gets printed when we start the new spinner in the background. We can disable this by turning off <a class="fancy-link" href="https://www.gnu.org/software/bash/manual/html_node/Job-Control-Basics.html#Job-Control-Basics" target="_blank">Job Control</a> in Bash via <code class="inline-code">set +m</code>. Let's modify our code some to add this.</p><pre class="code-container"><code class="block-code">set +m<br>spin &<br>pid=$!<br>...<br>kill -9 $pid</code></pre><p class="content-text">But wait, what if we wanted to start and stop the spinner on command? What if we needed to run a number of different functions between starting and stopping the spinner? Let's try to organize this a bit better.</p><p class="content-text">First, lets create a <code class="inline-code">start_spinner</code> function to handle what should happen when our spinner starts. Note that we'll have to make <code class="inline-code">$pid</code> a global variable, so let's rename it to <code class="inline-code">$spinner_pid</code> to be a bit more specific</p><pre class="code-container"><code class="block-code">spinner_pid=<br>function start_spinner {<br>    set +m<br>    spin &<br>    spinner_pid=$!<br>}</code></pre><p class="content-text">Okay, and now let's make another function <code class="inline-code">stop_spinner</code> to handle what should happen when our spinner stops.</p><pre class="code-container"><code class="block-code">function stop_spinner {<br>    kill -9 $spinner_pid<br>    set -m<br>}</code></pre><p class="content-text">Great! Now we can refactor our spinner code like so.</p><pre class="code-container"><code class="block-code">spinner_pid=<br>start_spinner<br>... # do some long running code<br>stop_spinner</code></pre><br><h4 class="content-subtitle">Handling edge cases</h4><p class="content-text">We've got a great foundation for a reproducible spinner. However, we should be careful of some edge cases. If we need to print to the command line, simply stopping the spinner will leave one of the spinner's characters around (<code class="inline-code">\</code>, <code class="inline-code">|</code>, <code class="inline-code">/</code>, or <code class="inline-code">-</code>). In addition, what happens if the script crashes? We'd be left with our out of control spinner on the command line and without knowledge of <code class="inline-code">$spinner_pid</code> to kill it.</p><p class="content-text">First, let's add some logic to <code class="inline-code">stop_spinner</code> to clear the current line when the spinner stops, so we don't leave any extra characters around. We can do this by using <a class="fancy-link" href="https://tldp.org/HOWTO/Bash-Prompt-HOWTO/c327.html" target="_blank">ANSI Escape Sequences</a>. You can get a quick overview of ANSI escape sequences <a class="fancy-link" href="https://askubuntu.com/questions/831971/what-type-of-sequences-are-escape-sequences-starting-with-033" target="_blank">here</a>. In addition, we should use the <code class="inline-code">wait</code> function to wait for our killed process to exit.</p><pre class="code-container"><code class="block-code">function stop_spinner {<br>    kill -9 $spinner_pid && wait<br>    set -m<br>    echo -en "\033[2K\r"<br>}</code></pre><p class="content-text">What does <code class="inline-code">echo -en "\033[2K\r"</code> do? Let's break it down. First, <code class="inline-code">echo -e</code> will allow <code class="inline-code">echo</code> to interpret escape sequences in its arguments and not print them as-is. Next, <code class="inline-code">echo -n</code> will print its arguments without a new line. The escape sequence <code class="inline-code">\033[2K</code> will erase the contents of the current line, and the carriage return <code class="inline-code">\r</code> will reset the cursor to the beginning of the line. This allows us to continue printing to the terminal normally after stopping our spinner.</p><p class="content-text">Next, let's handle what should happen should our script fail. With the current implementation, we'd be left with an out of control spinner on the terminal with no way of stopping it. We can implement a safeguard against this via a <a class="fancy-link" href="https://tldp.org/LDP/Bash-Beginners-Guide/html/sect_12_02.html" target="_blank">trap</a>. Essentially, we can specify a bit of code that runs when Bash exits. We already have the perfect code snippet that should run when the script exits, <code class="inline-code">stop_spinner</code>. Let's register an exit trap to use <code class="inline-code">stop_spinner</code> (make sure to do this <i>after</i> you've defined <code class="inline-code">stop_spinner</code>).</p><pre class="code-container"><code class="block-code">trap stop_spinner EXIT</code></pre><p class="content-text">There's one more gotcha we need to look our for. This trap will now run <i>every time the script exits</i>, even if it exits successfully. If the script exits cleanly, our <code class="inline-code">stop_spinner</code> function will try to execute <code class="inline-code">kill -9 $spinner_pid</code>, even though no process with PID <code class="inline-code">$spinner_pid</code> is running. To guard against this case, let's redirect <code class="inline-code">stderr</code> to the <a class="fancy-link" href="https://askubuntu.com/questions/350208/what-does-2-dev-null-mean" target="_blank">null device</a> in both <code class="inline-code">start_spinner</code> and <code class="inline-code">stop_spinner</code>. We'll need to wrap <code class="inline-code">spin</code> in curly braces for the job control to still function properly.</p><pre class="code-container"><code class="block-code">function start_spinner {<br>    set +m<br>    { spin & } 2&gt;/dev/null<br>    spinpid=$!<br>}<br><br>function stop_spinner {<br>    { kill -9 $spinner_pid && wait; } 2&gt;/dev/null<br>    set -m<br>    echo -en "\033[2K\r"<br>}</code></pre><br><h4 class="content-subtitle">More complex spinners</h4><p class="content-text">Maybe you've used tools like <a class="fancy-link" href="https://heroku.com/" target="_blank">Heroku</a> and seen their fancy spinners. While using <code class="inline-code">\</code>, <code class="inline-code">-</code>, <code class="inline-code">/</code>, and <code class="inline-code">|</code> is a great start, we can use some other characters to create even more powerful spinners.</p><p class="content-text">Let's upgrade our <code class="inline-code">spin</code> alias to a function and beef it up some.</p><pre class="code-container"><code class="block-code">function spin {<br>	while : ; do for X in '┤' '┘' '┴' '└' '├' '┌' '┬' '┐' ; do echo -en "\b$X" ; sleep 0.1 ; done ; done<br>}</code></pre><p class="content-text">Run this on the commad line to see how it looks! For even more fun spinners, check out <a class="fancy-link" href="https://github.com/heroku/heroku-cli-util/blob/master/lib/spinners.json" target="_blank">Heroku's CLI spinners</a>.</p><p class="content-text">Could we also print some output with our spinner? What about spinners that are more than one character? Yes and yes! Let's update <code class="inline-code">start_spinner</code> and <code class="inline-code">stop_spinner</code> to support this.</p><pre class="code-container"><code class="block-code">function start_spinner {<br>    set +m<br>    echo -n "$1         "<br>    { while : ; do for X in '  •     ' '   •    ' '    •   ' '     •  ' '      • ' '     •  ' '    •   ' '   •    ' '  •     ' ' •      ' ; do echo -en "\b\b\b\b\b\b\b\b$X" ; sleep 0.1 ; done ; done & } 2&gt;/dev/null<br>    spinner_pid=$!<br>}<br><br>function stop_spinner {<br>    { kill -9 $spinner_pid && wait; } 2&gt;/dev/null<br>    set -m<br>    echo -en "\033[2K\r"<br>}</code></pre><p class="content-text">Now we can call our spinner with a caption!</p><pre class="code-container"><code class="block-code">spinner_pid=<br>start_spinner "I'm thinking! "<br>...<br>stop_spinner</code></pre><p class="content-text">Try this out yourself on the command line!</p><br><h4 class="content-subtitle">The final product</h4><p class="content-text">Now that we've written <code class="inline-code">start_spinner</code> and <code class="inline-code">stop_spinner</code> once, we can just include these functions in all of our shell scripts going forward to enable some pretty awesome spinners. If you'd like to see the final, complete version of our spinner code, please refer to <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-snippets/blob/master/how-to-write-better-bash-spinners/snippet.bash" target="_blank">willcarh.art's snippet repo</a>.</p><p class="content-text">If you'd like to see how I've used this spinner in practice, check out <a class="fancy-link" href="../project/lurker.html">lurker</a> and <a class="fancy-link" href="../project/birdhouse.html">birdhouse</a>, as they both use a modified version of the code snippets developed in this blog post.</p><p class="content-text">Please spin responsibly.</p><p class="content-text centered-text">🦉</p>
</div>
<div class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<p id="cover-credit">Artwork by <a class="fancy-link" href="https://stock.adobe.com/contributor/207043170/painterstock" target="_blank">Painterstock</a></p>
</div>
<div id="blog-navigation-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<div class="row">
		<div class="col-md-1"></div>
		<div id="blog-navigation-back" class="col-md-4 blog-navigation-chunk">
			<h3><span class="show-more">⟵</span> Back</h3>
			<p class="navigation-detail-text content-text">Go back to the blog</p>
		</div>
		<div class="col-md-2"></div>
		<div id="blog-navigation-next" class="col-md-4 blog-navigation-chunk">
			<h3>Read More <span class="show-more">⟶</span></h3>
			<p class="navigation-detail-text content-text">Spinning Up a Fleet of DigitalOcean Droplets</p>
		</div>
		<div class="col-md-1"></div>
	</div>
</div>
<div class="spacer-small"></div>
			</div>
			<div class="spacer"></div>

			<div id="credits" class="row">
	<a id="footer-github-icon" href="https://github.com/wcarhart" target="_blank"><i class="fab fa-github"></i></a>
	<a id="footer-stackoverflow-icon" href="https://stackoverflow.com/users/6246128/wcarhart" target="_blank"><i class="fab fa-stack-overflow" data-fa-transform="left-2"></i></a>
	<a id="footer-linkedin-icon" href="https://linkedin.com/in/willcarhart" target="_blank"><i class="fab fa-linkedin" data-fa-transform="left-2"></i></a>
	<a id="footer-facebook-icon" href="../blog/why-i-deleted-my-facebook.html"><i class="fab fa-facebook-f" data-fa-transform="left-4"></i></a>
	<div style="text-align:center"><a class="fancy-link" href="../etc.html#license">&copy;&nbsp; Will Carhart <span id="year"></span></a></div>
</div>
			<div class="spacer-small"></div>
		</div>

		<!-- logo -->
		<a id="logo-container" href="../../index.html">
	<img id="logo" alt="willcarh.art logo" src="../../ico/android-chrome-512x512.png">
</a>

		<!-- dark mode toggle -->
		<div id="dark-mode-toggle-container">
	<button id="dark-mode-toggle"></button>
</div>
	</body>
</html>