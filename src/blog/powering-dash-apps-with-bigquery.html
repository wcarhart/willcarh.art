<!DOCTYPE html>
<!-- This is an autogenerated file - DO NOT EDIT DIRECTLY -->
<!-- This file was generated on Sat May 08 2021 00:50:52 GMT-0700 (Pacific Daylight Time) via the forge in willcarh.art v2.1.0-->
<!-- Learn more: https://github.com/wcarhart/willcarh.art -->
<!-- THIS IS A DEVELOPMENT BUILD, PROCEED WITH CAUTION! -->
<html lang="en">
	<head>
		<!-- metadata -->
		<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>willcarh.art</title>
<meta name="description" content="Powering Dash Apps with Bigquery" />
<meta name="twitter:card" value="summary" />
<meta property="og:name" content="willcarh.art" />
<meta property="og:url" content="https://willcarh.art/blog/powering-dash-apps-with-bigquery" />
<meta property="og:image" content="../../ico/android-chrome-512x512.png" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Powering Dash Apps with Bigquery" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="willcarh.art" />

		<!-- CSS -->
		<link rel="stylesheet" href="../../css/common.css">
		<link rel="stylesheet" href="../../css/logo.css">
		<link rel="stylesheet" href="../../css/darkmode.css">
		<link rel="stylesheet" href="../../css/fancylink.css">
		<link rel="stylesheet" href="../../css/linkicons.css">
		<link rel="stylesheet" href="../../css/list.css">
		<link rel="stylesheet" href="../../css/markdown.css">
		<link rel="stylesheet" href="../../css/credits.css">
		<link rel="stylesheet" href="../../css/blog_specific.css">

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

		<!-- Bootstrap CDN -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

		<!-- icons -->
		<link rel="apple-touch-icon" sizes="180x180" href="../../ico/apple-touch-icon.png">
	    <link rel="icon" type="image/png" sizes="32x32" href="../../ico/favicon-32x32.png">
	    <link rel="icon" type="image/png" sizes="16x16" href="../../ico/favicon-16x16.png">
	    <link rel="manifest" href="../../ico/site.webmanifest">

	    <!-- FontAwesome -->
	    <script src="https://use.fontawesome.com/releases/v5.5.0/js/all.js"></script>

		<!-- animate.css -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

		<!-- site analytics -->
		<script async defer data-domain="willcarh.art" src="https://plausible.io/js/plausible.js"></script>

		<!-- willcarh.art scripts -->
		<script src="../js/darkmode.js"></script>
		<script src="../js/year.js"></script>
		<script src="../js/epochtime.js"></script>
		<script src="../js/readtime.js"></script>
		<script src="../js/blognav.js"></script>
	</head>
	<body>
		<!-- text content -->
		<div id="content-main">
			<div class="spacer"></div>
			<div id="content-body">
				<div id="word-count" class="hidden-tidbit">4497</div>
<div id="read-time" class="hidden-tidbit">23 min read</div>
<div id="next-blog-link" class="hidden-tidbit">why-i-deleted-my-facebook</div>
<div id="blog-title-container" class="animate__animated animated_faster animate__fadeInUp animate__delay-1s">
	<h1 id="blog-title">Powering Dash Apps with BigQuery</h1>
	<h3 id="blog-subtitle">Dream big, query bigger</h3>
</div>
<div id="blog-credits" class="animate__animated animated_faster animate__fadeInUp animate__delay-2s">
	<div class="row justify-content-center">
		<div id="blog-author-img-container">
			<img id="blog-author-img" alt="author profile image" src="https://storage.googleapis.com/willcarh-art/img/profile.jpg">
		</div>
		<div id="blog-credits-details">
			<h5 id="blog-author">Will Carhart</h5>
			<p class="blog-metadata epochtime-hover">Published on March 12th, 2021 at 9:48 AM PST</p>
			<p class="blog-metadata epochtime-hover">Updated on May 2nd, 2021 at 11:45 PM PDT</p>
			<p class="blog-metadata readtime-hover"><span class="color">23 min read</span></p>
		</div>
	</div>
</div>
<div id="blog-cover-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<img id="blog-cover" alt="Powering Dash Apps with BigQuery cover image" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/cover.png">
</div>

<div id="blog-content-container" class="blog-border animate__animated animated_faster animate__fadeIn animate__delay-4s">
    <img class="content-img" alt="Mugato Zoolander Meme: top: reactive web apps, bottom: so hot right now" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/reactive-web-app-meme.jpeg"><p class="img-subtitle"></p><h4 class="content-subtitle">A primer on Plotly and Dash</h4><p class="content-text">It's an average day as a software engineer during COVID-19. You said last night you'd be up by 8am but it's 8:30am and you're still in bed. You make sure to check Slack on your phone so your co-workers think you're online despite the fact that the covers are pulled up to your nose. At 8:57am, you groggily roll out of bed for your 9am Zoom standup and put on the same sweatshirt from yesterday you left wadded on the floor. While someone drones on about semicolon rules in the repo's <code class="inline-code">.eslintrc</code> you hop on Reddit and browse <a class="fancy-link" href="https://www.reddit.com/r/dataisbeautiful/" target="_blank">r/DataIsBeautiful</a>. You're now awake gazing wide-eye at the beautiful visuals other software engineers and data scientists are creating. Someone made an interactive voting map for the US down to the city. Someone else made a <a class="fancy-link" href="https://www.reddit.com/r/dataisbeautiful/comments/kcy21p/oc_covid_19_dashboard_in_python_by_plotly_dash/" target="_blank">COVID-19 tracker</a>, with a cool <a class="fancy-link" href="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/r-slash-data-is-beautiful-covid19-tracker.mp4" target="_blank">demo video</a>. How do they make all this stuff so quickly?</p><p class="content-text">The answer is <a class="fancy-link" href="https://plotly.com/python/" target="_blank">Plotly</a> and <a class="fancy-link" href="https://plotly.com/dash/" target="_blank">Dash</a>. Built atop <a class="fancy-link" href="https://d3js.org/" target="_blank">D3.js</a> and <a class="fancy-link" href="http://stack.gl/" target="_blank">stack.gl</a>, Plotly is a high-level, declarative charting library. Combined with Dash, a productive framework for building web analytic applications with highly custom user interfaces in pure Python atop of Flask, Plotly.js, and React.js, it's possible to rapidly develop complex, reactive web apps with ease.</p><p class="content-text">Let's take a look at how we can build a powerful app from scratch using Plotly and Dash and data from <a class="fancy-link" href="https://cloud.google.com/bigquery" target="_blank">GCP BigQuery</a>.</p><br><h4 class="content-subtitle">Building charts with Plotly</h4><p class="content-text">The word "Plotly" is a bit ambiguous due to how Plotly has evolved over time. Initially <a class="fancy-link" href="https://plotly.com/javascript/" target="_blank">Plotly.js</a>, Plotly has developed a wide variety of visualization and data science related tools. Plotly is the name of the <a class="fancy-link" href="https://plotly.com/about-us/" target="_blank">company</a> behind the library, as well as the open-source library itself. It has graphing libraries for JavaScript (Plotly.js), Python, R, Julia, and more. For the rest of this article, when I mention Plotly I am talking about the Python Plotly library, unless otherwise noted.</p><p class="content-text">Plotly is a mature, fully-featured library and can seem complicated to dive into. That's why Plotly (the company) created <a class="fancy-link" href="https://plotly.com/python/plotly-express/" target="_blank">Plotly Express</a>, a terse, consistent, high-level API for creating figures. Let's get started with the Dash and Plotly ecosystem with Plotly Express.</p><p class="content-text">First, we'll need to install Plotly (and for Plotly Express, we'll also need <a class="fancy-link" href="https://pandas.pydata.org/" target="_blank">pandas</a>). Let's do some housekeeping beforehand to prepare.</p><div class="shoutout">
	<p class="shoutout-title"><b>Note</b></p>
	<p class="shoutout-text">I'm not going to cover pandas in depth because it's out of the scope of this article. If you haven't heard of it before, <a class="fancy-link" href="https://pandas.pydata.org/" target="_blank">pandas</a> is a super powerful data science-oriented library in Python. To get started, check out <a class="fancy-link" href="https://pandas.pydata.org/docs/getting_started/index.html" target="_blank">some of the tutorials</a> on pandas' website.</p>
</div><br><pre class="code-container"><code class="block-code">python3 -m virtualenv -p `which python3` venv<br>source venv/bin/activate<br>python -m pip install pandas<br>python -m pip install plotly</code></pre><p class="content-text">Next, let's use one of Plotly's dummy data sets to create a figure. For this example, we'll be using Plotly's <i>GDP per capita vs. life expectancy</i> dataset, an interesting relationship to study (but that's beside the point). Let's create a new file called <code class="inline-code">fig.py</code>.</p><pre class="code-container"><code class="block-code">import plotly.express as px<br>df = px.data.gapminder()<br>fig = px.scatter(df.query('year==2007'), x='gdpPercap', y='lifeExp', size='pop', color='continent', hover_name='country', log_x=True, size_max=60)<br>fig.show()</code></pre><p class="content-text">Now, we can run our app with <code class="inline-code">python fig.py</code>, which should open a new tab in the browser to display the generated figure.</p><img class="content-img" alt="Screenshot of generated Plotly figure of GDP per capita vs life expectancy" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/plotly-demo-0.png"><p class="img-subtitle">GDP Per Capita vs. Life Expectancy</p><p class="content-text">Pretty cool, right? Before we go any further, note that any Plotly figure comes out-of-the-box with some neat controls. Use the toolbar in the top right of the figure to zoom, box select, lasso select, download the figure as a PNG, and more. Here's what that toolbar will look like.</p><img class="content-img" alt="Screenshot of Plotly toolbar" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/plotly-demo-2.png"><p class="img-subtitle">Use the Plotly toolbar to interact with generated figures.</p><p class="content-text">Now, let's break down what we just built.</p><p class="content-text">The first line <code class="inline-code">import plotly.express as px</code> just imports Plotly Express from where Pip installed it. It's standard to call Plotly Express <code class="inline-code">px</code> for brevity.</p><p class="content-text">Next, we create a <a class="fancy-link" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html" target="_blank">pandas dataframe</a>, the standard data structure for pandas, from Plotly Express' test data set, which we instantiate with <code class="inline-code">px.data.gapminder()</code>. If you're curious, the data in the Gapminder dataset comes from <a class="fancy-link" href="https://www.gapminder.org/" target="_blank">gapminder.org</a>.</p><p class="content-text">Then, we use our dataframe to create a new figure. There are many different kinds of figures we can create with Plotly Express. For this example, we're using <code class="inline-code">px.scatter</code>, but other common Plotly figures are <code class="inline-code">px.bar</code>, <code class="inline-code">px.line</code>, and <code class="inline-code">px.area</code>. For the complete list, see the <a class="fancy-link" href="https://plotly.com/python-api-reference/plotly.express.html" target="_blank">Plotly Express documentation</a>. Plotly Express is nice because it gives us a single entrypoint into Plotly, and thus <code class="inline-code">px.scatter</code> can be configured in many different ways, which we control by which parameters we pass into its instantiation. For instance, let's change our third line to the following.</p><pre class="code-container"><code class="block-code">fig = px.scatter(df, x="gdpPercap", y="lifeExp", animation_frame="year", animation_group="country",<br>           size="pop", color="continent", hover_name="country", facet_col="continent",<br>           log_x=True, size_max=45, range_x=[100,100000], range_y=[25,90])</code></pre><p class="content-text">Run our code again and we'll see that the figure has changed dramatically, even though we're still using <code class="inline-code">px.scatter</code>.</p><img class="content-img" alt="Screenshot of updated Plotly graph of GDP per capita vs life expectancy" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/plotly-demo-1.png"><p class="img-subtitle">GDP Per Capita vs. Life Expectancy, grouped by continent, animated by year</p><p class="content-text">Finally, our last line <code class="inline-code">fig.show()</code> creates a <a class="fancy-link" href="https://flask.palletsprojects.com/en/1.1.x/" target="_blank">Flask</a> server to serve the figure, and then tears it down as soon as the figure is rendered in the browser. As we can see, we can build powerful figures easily with just Plotly alone, but what if we want them to update dynamically? Next, let's take a look at Dash and see if we can turn our static figure into a reactive web application.</p><br><h4 class="content-subtitle">Creating responsive web apps with Dash</h4><p class="content-text">You may have noticed that in the last Plotly example, the figure was already fairly interactive. You can move the slider below the graph to interact with the figure in real-time. So, what does Dash provide that Plotly does not?</p><p class="content-text">Dash allows you to create a web application to showcase your figures without writing any HTML, CSS, or JavaScript. It abstracts away all the web related details that often weigh down data scientists and application developers. Let's discuss the anatomy of a Dash app and create a simple example.</p><p class="content-text">First, let's talk about what a Dash app actually looks like. The simplest of Dash apps can be a single Python file, with a few elements:</p><ul><li>an <code class="inline-code">app.layout()</code> declaration, which sets up the app's visual structure and layout (this is sometimes included in a <code class="inline-code">main</code> function)</li><li>any number of callbacks using the <code class="inline-code">@app.callback()</code> decorator to run when something is triggered in the UI (e.g. a chart element is clicked or hovered)</li></ul><p class="content-text">First, let's install Dash. Make sure you're using the same environment from above, as we'll still need Plotly and pandas installed.</p><pre class="code-container"><code class="block-code">python -m pip install dash</code></pre><p class="content-text">Let's start with a basic skeleton for our Dash app. Create a new file called <code class="inline-code">app.py</code>.</p><pre class="code-container"><code class="block-code">import dash<br>import dash_html_components as html<br>from dash.dependencies import Input, Output<br><br>app = dash.Dash(__name__)<br><br>app.layout = html.Div([<br>    html.H1('Hello, Dash!', id='app-title'),<br>    html.Button('Change title', id='change-btn', n_clicks=0)<br>])<br><br>@app.callback(<br>    Output('app-title', 'children'),<br>    Input('change-btn', 'n_clicks')<br>)<br>def update_graph(n_clicks):<br>    if n_clicks % 2 == 0:<br>        return 'Hello, Dash!'<br>    return 'Hi there! Thanks for updating the title!'<br><br>if __name__ == '__main__':<br>    app.run_server(debug=True)</code></pre><p class="content-text">In your browser, navigate to <code class="inline-code">localhost:8050</code>. When you click the button, the title message will toggle. We made this all in Python, with no HTML, CSS, or JavaScript!</p><img class="content-img" alt="Screenshot of basic Dash app" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/dash-demo-0.gif"><p class="img-subtitle">Our simple Dash app so far.</p><p class="content-text">Let's break down our app so far.</p><p class="content-text">The first few lines are setting up Dash. We import Dash and its components, and then instantiate our app with <code class="inline-code">dash.Dash()</code>.</p><p class="content-text">Next, we define the HTML layout for our app with <code class="inline-code">app.layout</code>. We do this with Dash's HTML classes in <code class="inline-code">dash&#95;html&#95;components</code>. In our example, our app has one <code class="inline-code">div</code> containing an <code class="inline-code">h1</code> and a <code class="inline-code">button</code>, which we declare using <code class="inline-code">html.Div()</code>, <code class="inline-code">html.H1()</code>, and <code class="inline-code">html.Button()</code>.</p><p class="content-text">To enable our button's functionality, we use a callback. Callbacks are key to any Dash app's logic and are defined with the decorator <code class="inline-code">@app.callback()</code>. In the decorator, we define the inputs and outputs of the callback using <code class="inline-code">dash.dependencies.Input</code> and <code class="inline-code">dash.dependencies.Output</code>.</p><p class="content-text">The <code class="inline-code">Output</code> is what the callback will return. This can be an HTML element, a Plotly figure, or just a simple value like a string or integer. In our example, we use the syntax <code class="inline-code">'children'</code> when defining the <code class="inline-code">Output</code> to indicate that the value this callback will return is an HTML element or set of elements, which will be the <i>children</i> of the targeted component. The <code class="inline-code">Input</code> is what will trigger the callback. In most cases, this is some kind of input device, like a button or text input field. In our example, we're using a button. The syntax <code class="inline-code">n&#95;clicks=0</code> in our <code class="inline-code">app.layout</code> button definition acts a counter for how many times our button has been pressed. Because we registered <i>one</i> <code class="inline-code">Input</code> in our callback, the callback function takes <i>one</i> argument, <code class="inline-code">n&#95;clicks</code>. To attach our callback to specific HTML components in our <code class="inline-code">app.layout</code>, we use the associated IDs. As you can see, we gave our <code class="inline-code">h1</code> the ID <code class="inline-code">app-title</code> and our <code class="inline-code">button</code> the ID <code class="inline-code">change-btn</code>. We use these IDs in our callback to attach to these elements. Finally, the actual logic of the callback is fairly simple; we toggle between the two title messages every time the button is pressed.</p><div class="shoutout">
	<p class="shoutout-title"><b>Note</b></p>
	<p class="shoutout-text">The <code class="inline-code">n&#95;clicks</code> in <code class="inline-code">def update&#95;graph(n&#95;clicks)</code> is a user-named parameter, meaning we could name it whatever we want. On the contrary, the <code class="inline-code">n&#95;clicks</code> in <code class="inline-code">Input('change-btn', 'n&#95;clicks')</code> is a Dash keyword, which means to the number of times a button has been pressed. There are a certain set of keywords that refer to how input is passed to callback functions, like <code class="inline-code">value</code>, <code class="inline-code">options</code>, <code class="inline-code">n&#95;clicks</code>, and more. To learn more about Dash callbacks, check out <a class="fancy-link" href="https://dash.plotly.com/basic-callbacks" target="_blank">the documentation</a>.</p>
</div><br><p class="content-text">Then, to run our app we use <code class="inline-code">app.run&#95;server()</code>. Using the option <code class="inline-code">debug=True</code> will enable hot-reloading so the app is automatically refreshed when a code change is detected.</p><p class="content-text">Now, let's add some Plotly figures and try to make them interactive using Dash. As with Plotly, let's use a real dataset to make this interesting. We'll use the example country data from Plotly's <a class="fancy-link" href="https://plotly.github.io/datasets/country_indicators.csv" target="_blank">open source datasets</a>. First, let's set up our app so it can use Dash, Plotly, and pandas.</p><pre class="code-container"><code class="block-code">import dash<br>import dash_core_components as dcc<br>import dash_html_components as html<br>from dash.dependencies import Input, Output<br>import plotly.express as px<br>import pandas as pd<br><br>external_stylesheets = ['https://codepen.io/chriddyp/pen/bWLwgP.css']<br>app = dash.Dash(__name__, external_stylesheets=external_stylesheets)<br><br>df = pd.read_csv('https://plotly.github.io/datasets/country_indicators.csv')<br>available_indicators = df['Indicator Name'].unique()</code></pre><p class="content-text">We've added <code class="inline-code">external&#95;stylesheets</code> to give our app some simple CSS styling, and we've read the example country data into a pandas dataframe. Recall that the easiest way for Plotly to generate figures from data is using <a class="fancy-link" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.html" target="_blank">pandas dataframes</a>.</p><p class="content-text">Next, let's beef up our <code class="inline-code">app.layout</code> a bit so we have some more components to work with.</p><pre class="code-container"><code class="block-code">app.layout = html.Div([<br>    html.Div([<br>        html.Div([<br>            dcc.Dropdown(<br>                id='xaxis-column',<br>                options=[{'label': i, 'value': i} for i in available_indicators],<br>                value='Fertility rate, total (births per woman)'<br>            ),<br>            dcc.RadioItems(<br>                id='xaxis-type',<br>                options=[{'label': i, 'value': i} for i in ['Linear', 'Log']],<br>                value='Linear',<br>                labelStyle={'display': 'inline-block'}<br>            )<br>        ],<br>        style={'width': '48%', 'display': 'inline-block'}),<br>        html.Div([<br>            dcc.Dropdown(<br>                id='yaxis-column',<br>                options=[{'label': i, 'value': i} for i in available_indicators],<br>                value='Life expectancy at birth, total (years)'<br>            ),<br>            dcc.RadioItems(<br>                id='yaxis-type',<br>                options=[{'label': i, 'value': i} for i in ['Linear', 'Log']],<br>                value='Linear',<br>                labelStyle={'display': 'inline-block'}<br>            )<br>        ],style={'width': '48%', 'float': 'right', 'display': 'inline-block'})<br>    ]),<br>    dcc.Graph(id='indicator-graphic'),<br>    dcc.Slider(<br>        id='year--slider',<br>        min=df['Year'].min(),<br>        max=df['Year'].max(),<br>        value=df['Year'].max(),<br>        marks={str(year): str(year) for year in df['Year'].unique()},<br>        step=None<br>    )<br>])</code></pre><p class="content-text">Woah, a lot has changed in <code class="inline-code">app.layout</code>! Now, we've added a few more HTML elements, but we've also added some Dash core components: <code class="inline-code">dcc.Dropdown</code>, <code class="inline-code">dcc.RadioItems</code>, <code class="inline-code">dcc.Graph</code>, and <code class="inline-code">dcc.Slider</code>. Dash core components are essentially wrappers for Plotly figures or other entities that don't map one-to-one to standard HTML elements (and thus are not found in the <code class="inline-code">dash&#95;html&#95;components</code> module). <code class="inline-code">dcc.Dropdown</code> is a dropdown menu, <code class="inline-code">dcc.RadioItems</code> is a list of radio buttons with labels, <code class="inline-code">dcc.Graph</code> is a Plotly figure, and <code class="inline-code">dcc.Slider</code> is a slider control. For the complete list, check out the <a class="fancy-link" href="https://dash.plotly.com/dash-core-components" target="_blank">Dash Core Components documentation</a>.</p><p class="content-text">These Dash core components will allow us to build Plotly figures interactively. Pay close attention to the <code class="inline-code">dcc.Graph(id='indicator-graphic')</code>, as we'll use this element to build our figure. Notice that for now, there's no figure defined in the <code class="inline-code">dcc.Graph</code> syntax. This is because we will add it dynamically using a callback. If you run the app now, you won't see any cool visuals, because we haven't set up our callback. Let's do that next.</p><p class="content-text">In this example, our callback will have lots of inputs and one output (Dash also has <code class="inline-code">dash.dependencies.State</code>, but we won't be using that here). This is because we have dropdown menus, radio buttons, and slider controls that all impact the figure. Dash is smart enough to know how to combine all of these inputs and produce the desired figure. Let's take a look at our callback.</p><pre class="code-container"><code class="block-code">@app.callback(<br>    Output('indicator-graphic', 'figure'),<br>    Input('xaxis-column', 'value'),<br>    Input('yaxis-column', 'value'),<br>    Input('xaxis-type', 'value'),<br>    Input('yaxis-type', 'value'),<br>    Input('year--slider', 'value'))<br>def update_graph(xaxis_column_name, yaxis_column_name, xaxis_type, yaxis_type, year_value):<br>    dff = df[df['Year'] == year_value]<br><br>    fig = px.scatter(x=dff[dff['Indicator Name'] == xaxis_column_name]['Value'],<br>                     y=dff[dff['Indicator Name'] == yaxis_column_name]['Value'],<br>                     hover_name=dff[dff['Indicator Name'] == yaxis_column_name]['Country Name'])<br><br>    fig.update_layout(margin={'l': 40, 'b': 40, 't': 10, 'r': 0}, hovermode='closest')<br><br>    fig.update_xaxes(title=xaxis_column_name,<br>                     type='linear' if xaxis_type == 'Linear' else 'log')<br><br>    fig.update_yaxes(title=yaxis_column_name,<br>                     type='linear' if yaxis_type == 'Linear' else 'log')<br><br>    return fig</code></pre><p class="content-text">Again, a lot has changed in this callback from our original, simple example. Notice how there are five <code class="inline-code">Input</code>s in our callback decorator, for each of the <code class="inline-code">dcc.Dropdown</code>, <code class="inline-code">dcc.RadioItems</code>, and <code class="inline-code">dcc.Slider</code> that were defined in <code class="inline-code">app.layout</code>. That's why we see five parameters in the function definition. Recall that the actual names of these parameters are user-supplied, meaning <code class="inline-code">xaxis&#95;column&#95;name</code>, <code class="inline-code">yaxis&#95;column&#95;name</code>, <code class="inline-code">xaxis&#95;type</code>, <code class="inline-code">yaxis&#95;type</code>, and <code class="inline-code">year&#95;value</code> can be whatever you want, but they will map to the order defined in the callback decorator (e.g. the first <code class="inline-code">Input</code> with ID <code class="inline-code">xaxis-column</code> will map to the first parameter named <code class="inline-code">xaxis&#95;column&#95;name</code>). The purpose of the callback will be to return one <code class="inline-code">Output</code>, an updated Plotly figure, denoted by the syntax <code class="inline-code">'figure'</code> in the <code class="inline-code">Output</code> definition in the callback decorator. If our callback had multiple <code class="inline-code">Output</code>s, we would return them as a tuple. Within the callback, we grab the appropriate data, build the appropriate figure, and return it. We know what figure to build, and what columns to query from our pandas dataframe, by the values passed into our inputs, which are wired up to the actual HTML input elements on the webpage.</p><p class="content-text">Finally, to run our updated app, we use <code class="inline-code">app.run&#95;server()</code> again. If you're running multiple Dash apps concurrently, you'll have to use the parameter <code class="inline-code">port=xxxx</code> to not collide on the default Dash port (<code class="inline-code">8050</code>).</p><pre class="code-container"><code class="block-code">if __name__ == '__main__':<br>    app.run_server(debug=True)</code></pre><p class="content-text">Run the app and see the beautiful, interactive visualization!</p><img class="content-img" alt="Screen recording of more complex Dash app" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/dash-demo-1.gif"><p class="img-subtitle">Our more complex Dash app.</p><br><h4 class="content-subtitle">Loading data from BigQuery</h4><p class="content-text">Now that we can make some pretty powerful web applications with Dash and Plotly, let's look our datasets. So far, we've been using some of the datasets provided by Plotly. In the real world, however, this data will likely come from an external source, like an SQL table or a CSV file. Let's try our hand at importing data from <a class="fancy-link" href="https://cloud.google.com/bigquery" target="_blank">Google BigQuery</a>.</p><p class="content-text">First off, what is <a class="fancy-link" href="https://cloud.google.com/bigquery" target="_blank">BigQuery</a>? BigQuery is one of Google's cloud SQL products, and is advertised as a serverless, highly scalable, and cost-effective multi-cloud data warehouse designed for business agility. It can run SQL-like queries, and comes packed with ML and BI functionality out-of-the-box.</p><p class="content-text">For our dataset, we'll be using the <a class="fancy-link" href="https://console.cloud.google.com/bigquery?p=bigquery-public-data&d=hacker_news&page=dataset" target="_blank">Hacker News BigQuery dataset</a> that <a class="fancy-link" href="https://www.ycombinator.com/" target="_blank">YCombinator</a> has made available for independent projects. Let's take a look at how we can visualize this dataset with Dash and Plotly.</p><div class="shoutout">
	<p class="shoutout-title"><b>Heads Up!</b></p>
	<p class="shoutout-text">I'm not going to go too in depth with the <a class="fancy-link" href="https://cloud.google.com/" target="_blank">Google Cloud Platform (GCP)</a> because it's not the point of this article. If you're new to cloud computing or GCP, or you'd like to take a deeper dive into GCP, check out one of Google's helpful <a class="fancy-link" href="https://cloud.google.com/gcp/getting-started" target="_blank">Quickstarts</a>, which have good starter projects and lessons.</p>
</div><br><p class="content-text">First, let's get access to our dataset. Navigate to the <a class="fancy-link" href="https://console.cloud.google.com/bigquery?p=bigquery-public-data&d=hacker_news&page=dataset" target="_blank">Hacker News BigQuery dataset</a> and use the <code class="inline-code">COPY DATASET</code> button to add the dataset to your GCP console. If you've never used BigQuery before, you may need to create a dataset in your desired GCP project called <code class="inline-code">hacker&#95;news&#95;copy</code> and enable the <a class="fancy-link" href="https://cloud.google.com/bigquery-transfer/docs/enable-transfer-service" target="_blank">BigQuery Data Transfer Service</a>.</p><div class="shoutout">
	<p class="shoutout-title"><b>Note</b></p>
	<p class="shoutout-text">Since I named my dataset copy <code class="inline-code">hacker&#95;news&#95;copy</code>, I reference that name in the remainder of this article. If you picked a different name, you'll have to change it in the following code snippets.</p>
</div><br><p class="content-text">After you have the dataset copied to your GCP console, we'll need to create a service account in GCP to access the data programmatically. First, navigate to the <a class="fancy-link" href="https://console.cloud.google.com/apis/credentials/wizard" target="_blank">Credentials Wizard</a> to instigate the credential and service account creation process. Select the <i>BigQuery API</i>, <i>Application data</i>, and <i>No, I'm not using them</i> options (see screenshot below). If these options have changed since this article was published, follow whatever options lead you to create a service account.</p><img class="content-img" alt="Screenshot of credential and service account creation in GCP" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/dash-demo-2.png"><p class="img-subtitle">Options for setting up service account in GCP from the Credentials Wizard.</p><p class="content-text">Next, follow the prompts to create a new service account. When giving the new service account roles, make sure to add <i>BigQuery Admin</i> as a minimum (you can add as many others as you like). In addition, you can add yourself to the <i>Service account users role</i> and <i>Service account admin role</i> if you'd ever like to impersonate this service account in the future. Once your service account is created, navigate to the <a class="fancy-link" href="https://console.cloud.google.com/iam-admin/serviceaccounts" target="_blank">list of service accounts</a>, select the newly created service account, navigate to the <i>Keys</i> tab, and use the <code class="inline-code">ADD KEY</code> button to create a new JSON key.</p><div class="shoutout">
	<p class="shoutout-title"><b>Watch out!</b></p>
	<p class="shoutout-text">Your newly generated JSON key file will download immediately. Since this file allows unmitigated access to (some of) your cloud resources, make sure to store it somewhere securely and <i>do not</i> check it into version control. If you're unsure of where to put the file, a good starting spot is <code class="inline-code">/etc/keys/</code>.</p>
</div><br><p class="content-text">Next, let's install the BigQuery extension for pandas so we can execute queries programmatically. I'm assuming your environment is still set up from above (if not, make sure to reactivate your virtual environment). Back in your local terminal, use Pip to install it.</p><pre class="code-container"><code class="block-code">python -m pip install pandas-gbq</code></pre><p class="content-text">Phew, done with the boring stuff - let's get back to the code. Now we're finally ready to code up our application to interact with the Hacker News BigQuery dataset.</p><br><h4 class="content-subtitle">Our final product</h4><p class="content-text">First, let's set up our Dash app to use everything we've covered so far. We'll also need to use the Google Cloud SDK for Python to authenticate as our newly created service account in BigQuery. Here's what the app setup looks like. For brevity, I've omitted <code class="inline-code">dash.dependencies.Input</code> and <code class="inline-code">dash.dependencies.Output</code> because we won't be using any callbacks in this section. Callbacks are core to Dash's application structure, and I hope to cover them more in the future. For now, if you'd like to learn more about callbacks in Dash, check out <a class="fancy-link" href="https://dash.plotly.com/basic-callbacks" target="_blank">the documentation</a>.</p><pre class="code-container"><code class="block-code">import dash<br>import dash_table as dt<br>import dash_core_components as dcc<br>import dash_html_components as html<br>import plotly.express as px<br><br>import pandas as pd<br>from pandas.io import gbq<br><br>external_stylesheets = ['https://codepen.io/chriddyp/pen/bWLwgP.css']<br>app = dash.Dash(__name__, external_stylesheets=external_stylesheets)</code></pre><p class="content-text">Next, let's set up our app to execute BigQuery queries. We'll use the <code class="inline-code">google.oauth2.service&#95;account</code> module and the newly created JSON key file you downloaded from GCP.</p><pre class="code-container"><code class="block-code">from google.oauth2 import service_account<br>credentials = service_account.Credentials.from_service_account_file('/path/to/your/keyfile.json')</code></pre><p class="content-text">Now, let's create some actual queries. I'm going to use two queries from <a class="fancy-link" href="https://github.com/fhoffa" target="_blank">Felipe Hoffa</a>'s <a class="fancy-link" href="https://github.com/fhoffa/notebooks/blob/master/analyzing%20hacker%20news.ipynb" target="_blank">Analyzing Hacker News</a> Jupyter notebook to get started. Note that <a class="fancy-link" href="https://cloud.google.com/bigquery/docs/reference/legacy-sql" target="_blank">BigQuery prefers Standard SQL over Legacy SQL</a>, so we'll have to make a couple minor changes. Let's put our queries in a dictionary so they're easier to reference.</p><pre class="code-container"><code class="block-code">queries = {<br>    'top_types': 'SELECT type, COUNT(*) count FROM hacker_news_copy.full_201510 GROUP BY 1 ORDER BY 2 LIMIT 100',<br>    'counts': '''<br>        SELECT a.month month, stories, comments, comment_authors, story_authors<br>        FROM (<br>            SELECT FORMAT_TIMESTAMP('%Y-%m', time_ts) month, COUNT(*) stories, COUNT(DISTINCT author) story_authors<br>            FROM hacker_news_copy.stories<br>            GROUP BY 1<br>        ) a<br>        JOIN (<br>            SELECT FORMAT_TIMESTAMP('%Y-%m', time_ts) month, COUNT(*) comments, COUNT(DISTINCT author) comment_authors<br>            FROM hacker_news_copy.comments<br>            GROUP BY 1<br>        ) b<br>        ON a.month=b.month<br>        ORDER BY 1<br>    '''<br>}</code></pre><p class="content-text">Now, let's loop through these queries and create pandas dataframes for generating Plotly figures. Make sure to replace <code class="inline-code">&lt;PROJECTNAME&gt;</code> with your project's name in GCP.</p><pre class="code-container"><code class="block-code">dfs = {}<br>for query_name in queries:<br>    df = gbq.read_gbq(queries[query_name], project_id='&lt;PROJECTNAME&gt;', credentials=credentials)<br>    dfs[query_name] = df</code></pre><p class="content-text">Finally, let's make some visuals! The first query <code class="inline-code">top&#95;types</code> is just a simple report on the quantities in our data. We can put that in a simple, non-interactive table with Dash using <code class="inline-code">dash&#95;table</code>. This should have already been installed when we installed Dash.</p><pre class="code-container"><code class="block-code">import dash_table as dt<br>table_label = html.Label("Hacker News BigQuery Public Dataset")<br>table = dt.DataTable(<br>    id='top_types-table',<br>    columns=[{'name': i, 'id': i} for i in dfs['top_types'].columns],<br>    data=dfs['top_types'].to_dict('records'),<br>    style_cell={'textAlign': 'left'},<br>    style_data={<br>        'whiteSpace': 'normal',<br>        'height': 'auto'<br>    },<br>    fill_width=False<br>)</code></pre><img class="content-img" alt="Screenshot of a table resulting from our top_types query" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/dash-demo-3.png"><p class="img-subtitle">Our table from the <code class="inline-code">top&#95;types</code> query.</p><p class="content-text">Next, let's make some interactive graphs for our second query, <code class="inline-code">counts</code>. We'll make an animated histogram and a standard line chart. For the histogram, we'll need to restructure our data somewhat so Plotly can interpret it. Let's make a copy of our dataframe at <code class="inline-code">dfs['counts']</code> so we don't modify it for future figures.</p><pre class="code-container"><code class="block-code">df = dfs['counts'].copy(deep=True)<br>df.set_index('month', inplace=True)<br>df = df.unstack().reset_index()<br>df.columns = ['category', 'month', 'value']<br>fig = px.bar(<br>    df,<br>    x='category',<br>    y='value',<br>    color='category',<br>    animation_frame='month',<br>    range_y=[0,df['value'].max()*1.1],<br>    title='Hacker News interactions over time, animated'<br>)<br>histogram = dcc.Graph(id='counts-histogram', figure=fig)</code></pre><p class="content-text">First, we set the index to the <code class="inline-code">month</code> column, as that's what our animation will track. Next, we pivot our data around our index (<code class="inline-code">month</code>), previous column names, and the original values using <a class="fancy-link" href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.unstack.html" target="_blank"><code class="inline-code">pandas.DataFrame.unstack()</code></a>, and then rename the new columns appropriately. Finally, we build a figure using our newly restructured data.</p><img class="content-img" alt="Recording of animated histogram" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/dash-demo-4.gif"><p class="img-subtitle">Our animated histogram from the <code class="inline-code">counts</code> query.</p><p class="content-text">For the line chart, we'll need to add 4 separate traces, one for each of the dataframe's columns: <code class="inline-code">comments</code>, <code class="inline-code">stories</code>, <code class="inline-code">comment&#95;authors</code>, and <code class="inline-code">story&#95;authors</code>. To get more granular control of Plotly, we'll use the actual <code class="inline-code">Figure</code> class from <a class="fancy-link" href="https://plotly.com/python/graph-objects/" target="_blank"><code class="inline-code">plotly.graph&#95;objects</code></a>.</p><pre class="code-container"><code class="block-code">import plotly.graph_objects as go<br>fig = go.Figure()<br>for category in ['stories', 'comments', 'comment_authors', 'story_authors']:<br>    fig.add_trace(go.Scatter(<br>        x=dfs['counts']['month'], y=dfs['counts'][category],<br>        mode='lines+markers',<br>        name=category<br>    ))<br>fig.update_layout(title='Hacker News interactions over time')<br>line = dcc.Graph(id='counts-line', figure=fig)</code></pre><img class="content-img" alt="Screenshot of line graph from our counts query" src="https://storage.googleapis.com/willcarh-art/img/blog/powering-dash-apps-with-bigquery/dash-demo-5.png"><p class="img-subtitle">Our line chart from the <code class="inline-code">counts</code> query.</p><p class="content-text">Finally, to display all of our generated visuals with Dash, let's add our figures to our layout and serve the application.</p><pre class="code-container"><code class="block-code">app.layout = html.Div([<br>    table_label,<br>    table,<br>    histogram,<br>    line<br>])<br><br>if __name__ == '__main__':<br>    app.run_server(debug=True)</code></pre><br><h4 class="content-subtitle">Conclusion</h4><p class="content-text">Whew, you made it to the end! I know this was a lengthy post, but I hope it was well worth it. All of the code from this post is available in <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-snippets/tree/master/powering-dash-apps-with-bigquery" target="_blank">this repository</a> in case you'd like to fiddle with it yourself. I'm hoping this will be the first of more Dash posts to come, as Dash and Plotly are very powerful for building interactive and visually-pleasing web apps. We're only scratching the surface of what Dash and Plotly are able to do. If you'd like to learn more, the <a class="fancy-link" href="https://plotly.com/python/plotly-express/" target="_blank">Plotly Express documentation</a> is a great way to get started. Dash is also available in <a class="fancy-link" href="https://www.r-project.org/" target="_blank">R</a> and <a class="fancy-link" href="https://julialang.org/" target="_blank">Julia</a> if that's more your speed. In the spirit of learning, here is a <a class="fancy-link" href="https://stackoverflow.com/questions/67362391/in-a-plotly-histogram-how-to-make-each-animation-frame-a-row-in-the-dataframe" target="_blank">Stack Overflow question</a> I asked while updating this article. I'm far from the perfect software developer and am always learning myself.</p><br><p class="content-text centered-text">🦉</p>
</div>
<div class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<p id="cover-credit">Artwork by <a class="fancy-link" href="https://stock.adobe.com/contributor/208829706/brushinkin-paintings" target="_blank">Brushinkin paintings</a></p>
</div>
<div id="blog-navigation-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<div class="row">
		<div class="col-md-1"></div>
		<div id="blog-navigation-back" class="col-md-4 blog-navigation-chunk">
			<h3><span class="show-more">⟵</span> Back</h3>
			<p class="navigation-detail-text content-text">Go back to the blog</p>
		</div>
		<div class="col-md-2"></div>
		<div id="blog-navigation-next" class="col-md-4 blog-navigation-chunk">
			<h3>Read More <span class="show-more">⟶</span></h3>
			<p class="navigation-detail-text content-text">Why I Deleted My Facebook</p>
		</div>
		<div class="col-md-1"></div>
	</div>
</div>
<div class="spacer-small"></div>
			</div>
			<div class="spacer"></div>

			<div id="credits" class="row">
	<a id="footer-github-icon" href="https://github.com/wcarhart" target="_blank"><i class="fab fa-github"></i></a>
	<a id="footer-stackoverflow-icon" href="https://stackoverflow.com/users/6246128/wcarhart" target="_blank"><i class="fab fa-stack-overflow" data-fa-transform="left-2"></i></a>
	<a id="footer-linkedin-icon" href="https://linkedin.com/in/willcarhart" target="_blank"><i class="fab fa-linkedin" data-fa-transform="left-2"></i></a>
	<a id="footer-facebook-icon" href="../blog/why-i-deleted-my-facebook.html"><i class="fab fa-facebook-f" data-fa-transform="left-4"></i></a>
	<div style="text-align:center"><a class="fancy-link" href="../etc.html#license">&copy;&nbsp; Will Carhart <span id="year"></span></a></div>
</div>
			<div class="spacer-small"></div>
		</div>

		<!-- logo -->
		<a id="logo-container" href="../../index.html">
	<img id="logo" alt="willcarh.art logo" src="../../ico/android-chrome-512x512.png">
</a>

		<!-- dark mode toggle -->
		<div id="dark-mode-toggle-container">
	<button id="dark-mode-toggle"></button>
</div>
	</body>
</html>