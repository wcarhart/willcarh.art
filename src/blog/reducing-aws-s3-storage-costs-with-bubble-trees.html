<!DOCTYPE html>
<!-- This is an autogenerated file - DO NOT EDIT DIRECTLY -->
<!-- This file was generated on Mon May 10 2021 11:17:03 GMT-0700 (Pacific Daylight Time) via the forge in willcarh.art v2.1.0-->
<!-- Learn more: https://github.com/wcarhart/willcarh.art -->
<!-- THIS IS A DEVELOPMENT BUILD, PROCEED WITH CAUTION -->
<html lang="en">
	<head>
		<!-- metadata -->
		<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>willcarh.art</title>
<meta name="description" content="Reducing Aws S3 Storage Costs with Bubble Trees" />
<meta name="twitter:card" value="summary" />
<meta property="og:name" content="willcarh.art" />
<meta property="og:url" content="https://willcarh.art/blog/reducing-aws-s3-storage-costs-with-bubble-trees" />
<meta property="og:image" content="../../ico/android-chrome-512x512.png" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Reducing Aws S3 Storage Costs with Bubble Trees" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="willcarh.art" />

		<!-- CSS -->
		<link rel="stylesheet" href="../../css/common.css">
		<link rel="stylesheet" href="../../css/logo.css">
		<link rel="stylesheet" href="../../css/darkmode.css">
		<link rel="stylesheet" href="../../css/fancylink.css">
		<link rel="stylesheet" href="../../css/linkicons.css">
		<link rel="stylesheet" href="../../css/list.css">
		<link rel="stylesheet" href="../../css/markdown.css">
		<link rel="stylesheet" href="../../css/credits.css">
		<link rel="stylesheet" href="../../css/blog_specific.css">

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

		<!-- Bootstrap CDN -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

		<!-- icons -->
		<link rel="apple-touch-icon" sizes="180x180" href="../../ico/apple-touch-icon.png">
	    <link rel="icon" type="image/png" sizes="32x32" href="../../ico/favicon-32x32.png">
	    <link rel="icon" type="image/png" sizes="16x16" href="../../ico/favicon-16x16.png">
	    <link rel="manifest" href="../../ico/site.webmanifest">

	    <!-- FontAwesome -->
	    <script src="https://use.fontawesome.com/releases/v5.5.0/js/all.js"></script>

		<!-- animate.css -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

		<!-- site analytics -->
		<script async defer data-domain="willcarh.art" src="https://plausible.io/js/plausible.js"></script>

		<!-- willcarh.art scripts -->
		<script src="../js/darkmode.js"></script>
		<script src="../js/year.js"></script>
		<script src="../js/epochtime.js"></script>
		<script src="../js/readtime.js"></script>
		<script src="../js/blognav.js"></script>
	</head>
	<body>
		<!-- text content -->
		<div id="content-main">
			<div class="spacer"></div>
			<div id="content-body">
				<div id="word-count" class="hidden-tidbit">2570</div>
<div id="read-time" class="hidden-tidbit">13 min read</div>
<div id="next-blog-link" class="hidden-tidbit">building-chatbots-for-github</div>
<div id="blog-title-container" class="animate__animated animated_faster animate__fadeInUp animate__delay-1s">
	<h1 id="blog-title">Reducing AWS S3 Storage Costs with Bubble Trees</h1>
	<h3 id="blog-subtitle">No, there are not actually bubbles in the trees</h3>
</div>
<div id="blog-credits" class="animate__animated animated_faster animate__fadeInUp animate__delay-2s">
	<div class="row justify-content-center">
		<div id="blog-author-img-container">
			<img id="blog-author-img" alt="author profile image" src="https://storage.googleapis.com/willcarh-art/img/profile.jpg">
		</div>
		<div id="blog-credits-details">
			<h5 id="blog-author">Will Carhart</h5>
			<p class="blog-metadata epochtime-hover">Published on September 3rd, 2019 at 11:00 AM PDT</p>
			<p class="blog-metadata epochtime-hover"></p>
			<p class="blog-metadata readtime-hover"><span class="color">13 min read</span></p>
		</div>
	</div>
</div>
<div id="blog-cover-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<img id="blog-cover" alt="Reducing AWS S3 Storage Costs with Bubble Trees cover image" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/cover.jpg">
</div>

<div id="blog-content-container" class="blog-border animate__animated animated_faster animate__fadeIn animate__delay-4s">
    <div class="shoutout">
	<p class="shoutout-title"><b>Note</b></p>
	<p class="shoutout-text">This post will be talking about <a class="fancy-link" href="https://aws.amazon.com/s3/" target="_blank">Amazon Web Services (AWS) Simple Storage Solution (S3)</a>. If you're not familiar with this technology, <a class="fancy-link" href="https://aws.amazon.com/s3/getting-started/" target="_blank">here is a good primer</a>.</p>
</div><br><h4 class="content-subtitle">Understanding S3 pricing, and why things get expensive</h4><p class="content-text">For most of the companies I've worked for, storage accounted for one of the largest chunks of cloud infrastructure costs. From logging, database storage, artifact repostories, and more, storing data for any modern web application with a sizeable user base will exceed most cloud providers' free tiers. For example, let's take a look at <a class="fancy-link" href="https://aws.amazon.com/s3/pricing/" target="_blank">AWS S3 pricing</a> for <i>S3 Standard</i>, which is general purpose storage for any type of data and typically used for frequently accessed data.</p><table><thead><tr><th class="table-align-left" colspan="1">Usage</th>
<th class="table-align-left" colspan="1">Cost</th></tr></thead><tbody><tr><td class="table-align-left"> First 50 TB/month </td>
<td class="table-align-left"> &#36;0.023 per GB </td></tr>
<tr><td class="table-align-left"> Next 450 TB/month </td>
<td class="table-align-left"> &#36;0.022 per GB </td></tr>
<tr><td class="table-align-left"> Over 500 TB/month </td>
<td class="table-align-left"> &#36;0.021 per GB </td></tr></tbody></table><br><p class="content-text">23¢/GB/month may seem like a small price to pay. For a 1TB of data, that comes out to &#36;23/month.</p><p class="content-text">Let's use <a class="fancy-link" href="../blog/why-i-deleted-my-facebook.html">Facebook</a> as an example. As of writing this article, there are <a class="fancy-link" href="https://www.statista.com/statistics/264810/number-of-monthly-active-facebook-users-worldwide/" target="_blank">approximately 2.375 billion MAU</a> and <a class="fancy-link" href="https://www.businessinsider.com/facebook-350-million-photos-each-day-2013-9?IR=T" target="_blank">over 250 billion pictures</a> on Facebook (MAU means <i>monthly active users</i> in reference to a company's user base). Let's estimate the the average user has been on Facebook for about 5 years. This means that the average Facebook user uploads about 21 pictures per year, which Facebook compresses down to a <a class="fancy-link" href="https://qr.ae/pGtb6T" target="_blank">maximum of 100KB</a> per picture. In reality, Facebook likely uses a combination of storage solutions that are much cheaper than AWS S3, but let's assume for estimation sake that storage costs them 23¢/GB/month, just like us. This means that our upper bound cost estimate for Facebook to store the <i>average user's photos</i> is 0.05796¢/year. Seems like a near-zero cost...so why do we care?</p><br><h4 class="content-subtitle">Working with expensive amounts of data in S3</h4><p class="content-text">Let's think of some storage cases where the storage amount is a little greater. One of the most storage-heavy software applications is DNA sequencing and processing genomic data. <a class="fancy-link" href="https://www.illumina.com/" target="_blank">Illumina</a>, which is the world's leader in DNA sequencers, can produce close to <a class="fancy-link" href="https://support.illumina.com/bulletins/2018/01/approximate-sizes-of-sequencing-run-output-folders.html" target="_blank">800 GB of data</a> per execution of one of their high-end sequencers! If a massive lab has 50 sequencers running everyday for a month (incredibly unlikely, but proving a point), they would produce <b class="bold-text">1.2 Petabytes</b> of data on a monthly basis. In AWS, that's <b class="bold-text">over &#36;27,000</b> every month! For reference, that's about one one-millionth the <a class="fancy-link" href="https://starry.com/blog/inside-the-internet/how-big-is-the-internet" target="_blank">size of the internet in 2013</a>, generated every month. Is this a realistic example? Absolutely not. However, it does show us that when working with massive amounts of data, it's important to be cost-conscious.</p><p class="content-text">One way to do cut cloud storage costs is to set an expiry date for all of your objects, which states that each object will be deleted <i>x</i> days after it was uploaded. However, this poses another problem. Let's run with the Illumina example. If there are hundreds of scientists uploading data every day, how do we alert each individual scientist of when their data is about to be deleted? In order to prevent data loss, we should notify data owners prior to data deletion, which will give them time to move the data or extend the expiry date.</p><p class="content-text">How could we implement a solution to achieve this? Let's write out a few basic requirements of our solution:</p><ul><li><b class="bold-text">S3 is an object-store, not a regular file system!</b> This means that there are no folders or directories within a bucket, only objects. We can mimic folders by prefixing filenames with a pathnames.</li><li><b class="bold-text">We need to notify data owners well before their data expires</b> that it will be deleted. <i>For example, if I have a file that will be deleted in two months, I should get a notification at least one month prior to the deletion date.</i></li><li><b class="bold-text">We need this process to be reproducible and automated</b>, so it happens at a regular interval and doesn’t take away precious time from us (developers) and scientists (data owners at Illumina, or any other company with massive amounts of data).</li><li><b class="bold-text">Continuous S3 API calls can get expensive.</b> We want our solution to be as cheap as possible.</li></ul><p class="content-text">How will we accomplish sending out these notifications to data owners?</p><ol start=1><li><span>We will define a data structure to minimize the number of notifications while still being transparent about which data is expiring and when.</span></li><li><span>We will use a simple architecture of various AWS services to deploy our notification service.</span></li></ol><br><h4 class="content-subtitle">Constructing a new data structure: the Bubble Tree</h4><p class="content-text">Let's come up with a data structure to store our data. We need:</p><ol start=1><li><span>A way to store key-value pairs, where the key is the name of the object and the value is its expiry date.</span></li><li><span>A hierarchical structure, like a file system of paths.</span></li><li><span>A way to minimize the amount of key-value pairs the structure holds.</span></li></ol><p class="content-text">First, let's consider a <a class="fancy-link" href="https://en.wikipedia.org/wiki/Trie" target="_blank">trie</a>.</p><img class="content-img" alt="Trie data structure" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/trie.png"><p class="img-subtitle"></p><p class="content-text">This is a great start. What’s good about a standard trie for our use case? One, it stores key-value pairs, and two, it's hierarchical (great fit for our S3 bucket prefixes). Conversely, what’s not as great about a standard trie for our use case? Well, it's not as <i>minimal</i>. If two children, or leaves, of a node contain the same value, they are both stored.</p><p class="content-text">For example, consider the key-value pairs <code class="inline-code">{'/dir/file1.txt': 5, '/dir/file2.txt': 10}</code>. This would result in the following trie.</p><img class="content-img" alt="Trie data structure with asymmetrical data" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/asymmetrical-trie.png"><p class="img-subtitle"></p><p class="content-text">However, consider a trie with asymmetrical data, such as with the key-value pairs <code class="inline-code">{'/dir/file1.txt': 5, '/dir/file2.txt': 5}</code>. This would result in a trie with three nodes, even though both the leaf nodes have the same value.</p><img class="content-img" alt="Trie data structure with symmetrical data" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/symmetrical-trie.png"><p class="img-subtitle"></p><p class="content-text">In our case, a simpler representation the data would be <code class="inline-code">{'/dir': 5}</code>, because we know that all of the contents of <code class="inline-code">dir</code> have the value <code class="inline-code">5</code>.</p><p class="content-text">Let's create a new kind of tree data structure, which we'll call the <b class="bold-text">bubble tree</b>. A bubble tree will be very similar to a trie, but with the following condition: we say that the value of a node <i>bubbles up</i> to its parent if the value of the node is equivalent to the values of all of its siblings.</p><p class="content-text">That sounds complicated in writing, but it's easier to visualize. Check out this simple animation of values bubbling up in a bubble tree.</p><img class="content-img" alt="Bubble tree bubbling example animation" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/bubbletree-bubbling-example.gif"><p class="img-subtitle"></p><br><h4 class="content-subtitle">Planting our bubble tree</h4><p class="content-text">Let's get to implementing our bubble tree in Python. First, let's define a new class for a node in the bubble tree.</p><pre class="code-container"><code class="block-code">class BubbleTreeNode:<br>    '''Tree that 'bubbles up' common values from subtrees'''<br>    def __init__(self, path, value=None):<br>        self.path = path<br>        self.value = value<br>        self.children = []</code></pre><p class="content-text">Each node in a bubble tree with have a path (e.g. <code class="inline-code">/dir/file.txt</code>), a value (e.g. <code class="inline-code">5</code>), and a list of its children nodes.</p><p class="content-text">Next, we'll need to implement three different functions for our bubble tree. All of the following will be implemented as class methods so they have access to the current <code class="inline-code">BubbleTreeNode</code>.</p><ol start=1><li><span><code class="inline-code">insert()</code> for inserting into a bubble tree</span></li><li><span><code class="inline-code">bubble()</code> to bubble up identical leaf nodes</span></li><li><span><code class="inline-code">flatten()</code> to convert the bubble tree to a flat dictionary of key-value pairs</span></li></ol><br><div class="shoutout">
	<p class="shoutout-title"><b>Wait just a second!</b></p>
	<p class="shoutout-text">Wondering how we can print a complex bubble tree in a nice way? Check out my blog post for <a class="fancy-link" href="../blog/how-to-print-file-trees-on-the-command-line.html">building pretty trees on the command line</a>, which lifts code directly out of the <a class="fancy-link" href="https://github.com/wcarhart/algos/blob/master/trees.py" target="_blank">bubble tree source</a> in my <a class="fancy-link" href="../project/algos.html">algos</a> project.</p>
</div><br><p class="content-text">Let's start with <code class="inline-code">insert()</code>, which is the most complicated. Inserting into a bubble tree is almost identical to inserting into a trie.</p><pre class="code-container"><code class="block-code">def insert(self, path, value=None):<br>    '''Provide a full path to be inserted'''<br>    items = path.strip('/').split('/')<br>    assert items[0] == self.path, 'Invalid insert path in tree'<br>    self.insert_at_path(items[-1], items[:-1], value)<br><br>def insert_at_path(self, path, tree_path, value):<br>    '''Insert new value at a specific path'''<br>    self.__insert_at_path(self, path, tree_path, value)<br><br>def __insert_at_path(self, treenode, path, tree_path, value):<br>    if len(tree_path) == 1:<br>        if treenode.path == tree_path[0]:<br>            treenode.children.append(BubbleTreeNode(path, value=value))<br>        else:<br>            raise ValueError('Invalid insert path in tree')<br>    else:<br>        if len(tree_path) &gt; 1:<br>            try:<br>                index = next(i for i, child in enumerate(treenode.children) if child.path == tree_path[1])<br>                self.__insert_at_path(treenode.children[index], path, tree_path[1:], value)<br>            except StopIteration:<br>                treenode.children.append(BubbleTreeNode(tree_path[1]))<br>                self.__insert_at_path(treenode.children[-1], path, tree_path[1:], value)<br>        else:<br>            raise ValueError('Invalid insert path in tree')</code></pre><p class="content-text">Next, let's implement <code class="inline-code">bubble()</code>, so our leaf nodes can <i>bubble up</i> to their parent.</p><pre class="code-container"><code class="block-code">def bubble(self):<br>    '''Bubble up values in the tree and prune congruent subtrees'''<br>    self.__bubble(self)<br><br>def __bubble(self, treenode):<br>    if not treenode.children:<br>        return<br>    for child in treenode.children:<br>        self.__bubble(child)<br>    if all(child.value == treenode.children[0].value for children in treenode.children):<br>        treenode.value = treenode.children[0].value<br>        treenode.children = []</code></pre><p class="content-text">Finally, let's implement <code class="inline-code">flatten()</code>. This will allow us to convert the bubble tree to a dictionary of key-value pairs for easier parsing.</p><pre class="code-container"><code class="block-code">def flatten(self):<br>    '''Flatten the tree into key-value pairs'''<br>    return self.__flatten(self, '', {})<br><br>def __flatten(self, treenode, prefix, result):<br>    if treenode.value:<br>        result['/'.join([prefix, treenode.path])] = treenode.value<br>    else:<br>        for child in treenode.children:<br>            result = self.__flatten(child, '/'.join([prefix, treenode.path]), result)<br>    return result</code></pre><p class="content-text">Great! Now we can create a bubble tree with the <code class="inline-code">BubbleTreeNode</code> class.</p><pre class="code-container"><code class="block-code">&gt;&gt;&gt; bt = BubbleTreeNode('root')</code></pre><p class="content-text">Insert some data.</p><pre class="code-container"><code class="block-code">&gt;&gt;&gt; bt.insert('/root/dir0/dir00/file000.txt', value=10)<br>&gt;&gt;&gt; bt.insert('/root/dir0/file00.txt', value=10)<br>&gt;&gt;&gt; bt.insert('/root/dir1/file10.txt', value=5)<br>&gt;&gt;&gt; bt.insert('/root/dir2/file20.txt', value=10)<br>&gt;&gt;&gt; bt.insert('/root/dir2/file21.txt', value=15)<br>&gt;&gt;&gt; bt.insert('/root/dir3/dir30/file300.txt', value=15)<br>&gt;&gt;&gt; bt.insert('/root/dir3/file30.txt', value=10)</code></pre><p class="content-text">Bubble up common values to prune the bubble tree.</p><pre class="code-container"><code class="block-code">&gt;&gt;&gt; print(bt)<br>└── root<br>    ├── dir0<br>    |   ├── dir00<br>    |   |   └── file000.txt (10)<br>    |   └── file00.txt (10)<br>    ├── dir1<br>    |   └── file10.txt (5)<br>    ├── dir2<br>    |   ├── file20.txt (10)<br>    |   └── file21.txt (15)<br>    └── dir3<br>        ├── dir30<br>        |   └── file300.txt (15)<br>        └── file30.txt (10)<br>&gt;&gt;&gt; bt.bubble()<br>&gt;&gt;&gt; print(bt)<br>└── root<br>    ├── dir0 (10)<br>    ├── dir1 (5)<br>    ├── dir2<br>    |   ├── file20.txt (10)<br>    |   └── file21.txt (15)<br>    └── dir3<br>        ├── dir30 (15)<br>        └── file30.txt (10)</code></pre><p class="content-text">And finally, flatten the bubble tree.</p><pre class="code-container"><code class="block-code">&gt;&gt;&gt; bt.flatten()<br>{<br>  '/root/dir0': 10,<br>  '/root/dir1': 5,<br>  '/root/dir2/file20.txt': 10,<br>  '/root/dir2/file21.txt': 15,<br>  '/root/dir3/dir30': 15,<br>  '/root/dir3/file30.txt': 10<br>}</code></pre><br><h4 class="content-subtitle">Adding AWS infrastructure</h4><p class="content-text">Now that we have a working bubble tree, let’s consider how we’re going to deploy it to serve our notifications. We'll need some infrastructure to accomplish the following.</p><ol start=1><li><span>A way to query an S3 bucket on a regular basis.</span></li><li><span>A way to aggregate expiry dates into a minimal number of notifications (via a bubble tree).</span></li><li><span>A way to actually send the notifications.</span></li></ol><p class="content-text">Rather than actually implement this infrastructure, I'm just going to model it out. Implementing this infrastructure extends beyond the scope of a single blog post, but I still wanted to touch on how to accomplish it. Here's a brief interactive animation to showcase how to build everything in AWS.</p><script src="../js/slideshow.js"></script>
<div class="markdown-slideshow-container">
    <div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-0.png" alt="Inline slideshow, slide 1" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-1.png" alt="Inline slideshow, slide 2" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-2.png" alt="Inline slideshow, slide 3" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-3.png" alt="Inline slideshow, slide 4" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-4.png" alt="Inline slideshow, slide 5" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-3.png" alt="Inline slideshow, slide 6" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-5.png" alt="Inline slideshow, slide 7" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-6.png" alt="Inline slideshow, slide 8" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-7.png" alt="Inline slideshow, slide 9" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
<div class="markdown-slideshow-slide markdown-slideshow-fade">
    <img class="markdown-slideshow-slide-content" src="https://storage.googleapis.com/willcarh-art/img/blog/reducing-aws-s3-storage-costs-with-bubble-trees/aws-diagram-8.png" alt="Inline slideshow, slide 10" style="width:100%">
    <div class="markdown-slideshow-slide-caption"></div>
</div>
    <a class="markdown-slideshow-prev" onclick="plusSlides(-1)">&#10094;</a>
    <a class="markdown-slideshow-next" onclick="plusSlides(1)">&#10095;</a>
</div>
<br>
<div class="markdown-slideshow-dots" style="text-align:center">
    <span class="markdown-slideshow-dot" onclick="currentSlide(1)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(2)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(3)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(4)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(5)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(6)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(7)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(8)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(9)"></span>
<span class="markdown-slideshow-dot" onclick="currentSlide(10)"></span>
</div><br><h4 class="content-subtitle">A look at the cost</h4><p class="content-text">Now for the moment we've all been waiting for...did this effort save us any money? Let's assume for simplicity that we have an S3 bucket with one million objects total that we'd like to send expiry warnings for. Let's calculate our cost per execution based on what AWS services we used (this is using the pricing example found under the <i>S3 Object Lambda</i> tab on the <a class="fancy-link" href="https://aws.amazon.com/s3/pricing/" target="_blank">AWS S3 Pricing page</a>).</p><table><thead><tr><th class="table-align-center" colspan="1">AWS Service</th>
<th class="table-align-center" colspan="1">Estimated Usage</th>
<th class="table-align-center" colspan="1">Estimated Cost</th></tr></thead><tbody><tr><td class="table-align-center"><i>Lambda</i></td>
<td class="table-align-center">2 simple functions</td>
<td class="table-align-center">Free Tier</td></tr>
<tr><td class="table-align-center"><i>SNS</i></td>
<td class="table-align-center">Just a few messages</td>
<td class="table-align-center">Free Tier</td></tr>
<tr><td class="table-align-center"><i>CloudWatch</i></td>
<td class="table-align-center">Kick off monthly workflow</td>
<td class="table-align-center">Free Tier</td></tr>
<tr><td class="table-align-center"><i>S3</i></td>
<td class="table-align-center">~1 million objects, each accessed twice</td>
<td class="table-align-center">~&#36;20</td></tr></tbody></table><br><p class="content-text">Great! We've worked out a solution that, other than engineering hours, only costs us &#36;20/execution to run. To put that &#36;20 in context, imagine that we could save up to &#36;1000/month by sending out expiry notifications on a monthly basis (this is not an unrealistic example). It is an great trade-off to pay &#36;20/month for a chance to save &#36;1000/month. That comes out to &#36;1040/year for weekly expiry notifications, &#36;240/year for monthly expiry notifications, and &#36;80/year for quarterly expiry notifications.</p><p class="content-text">Pretty affordable. Can we make it even <i>less</i> expensive?</p><p class="content-text">The current pricing model is greedy because it assumes that you must send two <a class="fancy-link" href="https://docs.aws.amazon.com/AmazonS3/latest/API/Welcome.html" target="_blank">AWS S3 API</a> requests per object in the bucket. If we could reduce the number of API requests per bucket-object, we would dramatically lower our overall cost. Instead of using <a class="fancy-link" href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetObjectRetention.html" target="_blank">GetObjectRetention</a> for each object in the bucket, we could use <a class="fancy-link" href="https://docs.aws.amazon.com/AmazonS3/latest/API/API_ListObjectsV2.html" target="_blank">ListObjectsV2</a>, which returns metadata for up to 1000 objects in a bucket. If we assume the rough price model of &#36;10 per one million S3 API requests from above, we would only need to send 1000 requests for a bucket of one million objects, instead of two million requests. This results in a new cost of <b class="bold-text">1¢ per execution</b>, a cost reduction of 2000%! If it only costs 1¢ to run this solution, we could run it every day! Keep in mind that these numbers are all estimations; the actual cost could vary wildly based on your infrastructure implementation.</p><br><h4 class="content-subtitle">Conclusion</h4><p class="content-text">The bubble tree data structure is very powerful. This has been just one cool use case for it, but a "simplifiable trie," which is essentially what a BubbleTrie is, has plently of applications. I'll leave the next killer bubble tree app to you, my dear reader.</p><p class="content-text">If you'd like to take a look at bubble tree's code, check out my project <a class="fancy-link" href="../project/algos.html">algos</a>, which has a bunch of standard and novel algorithms and data structure implementations in Python. You can also read <a class="fancy-link" href="https://github.com/wcarhart/algos/blob/master/trees.py" target="_blank">bubble tree's source code</a>, which contains other tree structures as well. If this is your first exposure to AWS, or you're looking to dive deeper, a great place to start is <a class="fancy-link" href="https://aws.amazon.com/getting-started/" target="_blank">AWS's tutorials</a>, where you can pick interactive tutorials based on what kind of developer you are (embedded, back-end, etc). Even though AWS was the pioneer of S3, nearly <a class="fancy-link" href="https://cloud.google.com/storage" target="_blank">every</a> <a class="fancy-link" href="https://www.digitalocean.com/products/spaces/" target="_blank">other</a> IaaS provider has a similar product, many of which work with AWS S3's API.</p><p class="content-text">Now go, prune the world's trees of duplicate data.</p><br><p class="content-text centered-text">🦉</p>
</div>
<div class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<p id="cover-credit">Artwork by <a class="fancy-link" href="https://stock.adobe.com/contributor/205152658/pronoia" target="_blank">pronoia</a></p>
</div>
<div id="blog-navigation-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<div class="row">
		<div class="col-md-1"></div>
		<div id="blog-navigation-back" class="col-md-4 blog-navigation-chunk">
			<h3><span class="show-more">⟵</span> Back</h3>
			<p class="navigation-detail-text content-text">Go back to the blog</p>
		</div>
		<div class="col-md-2"></div>
		<div id="blog-navigation-next" class="col-md-4 blog-navigation-chunk">
			<h3>Read More <span class="show-more">⟶</span></h3>
			<p class="navigation-detail-text content-text">Building Chatbots for GitHub</p>
		</div>
		<div class="col-md-1"></div>
	</div>
</div>
<div class="spacer-small"></div>
			</div>
			<div class="spacer"></div>

			<div id="credits" class="row">
	<a id="footer-github-icon" href="https://github.com/wcarhart" target="_blank"><i class="fab fa-github"></i></a>
	<a id="footer-stackoverflow-icon" href="https://stackoverflow.com/users/6246128/wcarhart" target="_blank"><i class="fab fa-stack-overflow" data-fa-transform="left-2"></i></a>
	<a id="footer-linkedin-icon" href="https://linkedin.com/in/willcarhart" target="_blank"><i class="fab fa-linkedin" data-fa-transform="left-2"></i></a>
	<a id="footer-facebook-icon" href="../blog/why-i-deleted-my-facebook.html"><i class="fab fa-facebook-f" data-fa-transform="left-4"></i></a>
	<div style="text-align:center"><a class="fancy-link" href="../etc.html#license">&copy;&nbsp; Will Carhart <span id="year"></span></a></div>
</div>
			<div class="spacer-small"></div>
		</div>

		<!-- logo -->
		<a id="logo-container" href="../index.html">
	<img id="logo" alt="willcarh.art logo" src="../../ico/android-chrome-512x512.png">
</a>

		<!-- dark mode toggle -->
		<div id="dark-mode-toggle-container">
	<button id="dark-mode-toggle"></button>
</div>
	</body>
</html>