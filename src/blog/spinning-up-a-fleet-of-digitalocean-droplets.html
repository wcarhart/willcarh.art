<!DOCTYPE html>
<!-- This is an autogenerated file - DO NOT EDIT DIRECTLY -->
<!-- This file was generated on Mon May 10 2021 18:46:45 GMT-0700 (Pacific Daylight Time) via the forge in willcarh.art v2.1.0-->
<!-- Learn more: https://github.com/wcarhart/willcarh.art -->
<!-- THIS IS A DEVELOPMENT BUILD, PROCEED WITH CAUTION -->
<html lang="en">
	<head>
		<!-- metadata -->
		<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>willcarh.art</title>
<meta name="description" content="Spinning Up a Fleet of Digitalocean Droplets" />
<meta name="twitter:card" value="summary" />
<meta property="og:name" content="willcarh.art" />
<meta property="og:url" content="https://willcarh.art/blog/spinning-up-a-fleet-of-digitalocean-droplets" />
<meta property="og:image" content="../ico/android-chrome-512x512.png" />
<meta property="og:type" content="website" />
<meta property="og:description" content="Spinning Up a Fleet of Digitalocean Droplets" />
<meta property="og:locale" content="en_US" />
<meta property="og:site_name" content="willcarh.art" />

		<!-- CSS -->
		<link rel="stylesheet" href="../css/common.css">
		<link rel="stylesheet" href="../css/logo.css">
		<link rel="stylesheet" href="../css/darkmode.css">
		<link rel="stylesheet" href="../css/fancylink.css">
		<link rel="stylesheet" href="../css/linkicons.css">
		<link rel="stylesheet" href="../css/list.css">
		<link rel="stylesheet" href="../css/markdown.css">
		<link rel="stylesheet" href="../css/credits.css">
		<link rel="stylesheet" href="../css/blog_specific.css">

		<!-- jQuery -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

		<!-- Bootstrap CDN -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

		<!-- icons -->
		<link rel="apple-touch-icon" sizes="180x180" href="../ico/apple-touch-icon.png">
	    <link rel="icon" type="image/png" sizes="32x32" href="../ico/favicon-32x32.png">
	    <link rel="icon" type="image/png" sizes="16x16" href="../ico/favicon-16x16.png">
	    <link rel="manifest" href="../ico/site.webmanifest">

	    <!-- FontAwesome -->
	    <script src="https://use.fontawesome.com/releases/v5.5.0/js/all.js"></script>

		<!-- animate.css -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

		<!-- site analytics -->
		<script async defer data-domain="willcarh.art" src="https://plausible.io/js/plausible.js"></script>

		<!-- willcarh.art scripts -->
		<script src="../js/darkmode.js"></script>
		<script src="../js/year.js"></script>
		<script src="../js/epochtime.js"></script>
		<script src="../js/readtime.js"></script>
		<script src="../js/blognav.js"></script>
	</head>
	<body>
		<!-- text content -->
		<div id="content-main">
			<div class="spacer"></div>
			<div id="content-body">
				<div id="word-count" class="hidden-tidbit">2135</div>
<div id="read-time" class="hidden-tidbit">11 min read</div>
<div id="next-blog-link" class="hidden-tidbit">on-failure</div>
<div id="blog-title-container" class="animate__animated animated_faster animate__fadeInUp animate__delay-1s">
	<h1 id="blog-title">Spinning Up a Fleet of DigitalOcean Droplets</h1>
	<h3 id="blog-subtitle">How to create your own minions</h3>
</div>
<div id="blog-credits" class="animate__animated animated_faster animate__fadeInUp animate__delay-2s">
	<div class="row justify-content-center">
		<div id="blog-author-img-container">
			<img id="blog-author-img" alt="author profile image" src="https://storage.googleapis.com/willcarh-art/img/profile.jpg">
		</div>
		<div id="blog-credits-details">
			<h5 id="blog-author">Will Carhart</h5>
			<p class="blog-metadata epochtime-hover">Published on February 11th, 2020 at 11:05 AM PST</p>
			<p class="blog-metadata epochtime-hover"></p>
			<p class="blog-metadata readtime-hover"><span class="color">11 min read</span></p>
		</div>
	</div>
</div>
<div id="blog-cover-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<img id="blog-cover" alt="Spinning Up a Fleet of DigitalOcean Droplets cover image" src="https://storage.googleapis.com/willcarh-art/img/blog/spinning-up-a-fleet-of-digitalocean-droplets/cover.jpg">
</div>

<div id="blog-content-container" class="blog-border animate__animated animated_faster animate__fadeIn animate__delay-4s">
    <h4 class="content-subtitle">A brief intro into DigitalOcean</h4><p class="content-text">If you've done any kind of web development in the past decade, I'm sure you've run into at least one of the three big <a class="fancy-link" href="https://azure.microsoft.com/en-us/overview/what-is-iaas/" target="_blank">IaaS</a> providers: <a class="fancy-link" href="https://aws.amazon.com/" target="_blank">Amazon Web Services (AWS)</a>, <a class="fancy-link" href="https://cloud.google.com/" target="_blank">Google Cloud Platform (GCP)</a>, and <a class="fancy-link" href="https://azure.microsoft.com/en-us/" target="_blank">Microsoft Azure</a>. While many companies (and independent developers) rely on these three companies for lots of services and products, there are other smaller Iaas and <a class="fancy-link" href="https://azure.microsoft.com/en-us/overview/what-is-paas/" target="_blank">PaaS</a> providers. One of these is <a class="fancy-link" href="https://www.digitalocean.com/" target="_blank">DigitalOcean</a>.</p><p class="content-text">DigitalOcean is a company I use regularly for compute resources. I like their platform because unlike some of the bigger companies in this space, the VM creation workflow is much more streamlined on DigitalOcean (VMs are called <a class="fancy-link" href="https://www.digitalocean.com/products/droplets/" target="_blank"><i>droplets</i></a> on DigitalOcean). The simplest droplet is &#36;5/month, can be created in seconds with the UI, API, or CLI. Is there any functionality not offered by AWS, GCP, or Azure? No, but I still enjoy using DigitalOcean more for personal projects, <i>especially</i> in the early stages.</p><br><h4 class="content-subtitle">A look at DigitalOcean's services</h4><p class="content-text">DigitalOcean has a variety of services, from VMs to managed web apps to S3-like storage to databases, Kubernetes, and more. The most basic resource on DigitalOcean is the <a class="fancy-link" href="https://www.digitalocean.com/products/droplets/" target="_blank">droplet</a>, which is DigitalOcean's name for their VM product. You can usually get one spun up in less than an minute and be ssh'ed in making changes immediately after. I use droplets whenever I need to test out projects - you can actually see a video of two droplets communicating with each other for the demo of my project <a class="fancy-link" href="../project/aerogram.html">aerogram</a>. What makes DigitalOcean even more powerful is their <a class="fancy-link" href="https://developers.digitalocean.com/documentation/v2/" target="_blank">API</a> and <a class="fancy-link" href="https://github.com/digitalocean/doctl" target="_blank">CLI tool <code class="inline-code">doctl</code></a>. Using the API and <code class="inline-code">doctl</code> we can create and tear down droplets programatically.</p><br><h4 class="content-subtitle">Being a power user with the DigitalOcean API</h4><p class="content-text">Let's take a look at how we can spin up droplets using the <a class="fancy-link" href="https://developers.digitalocean.com/documentation/v2/" target="_blank">DigitalOcean API</a>. First, make sure you <a class="fancy-link" href="https://cloud.digitalocean.com/account/api/tokens" target="_blank">create an API token</a>. We'll <code class="inline-code">POST</code> to the <a class="fancy-link" href="https://developers.digitalocean.com/documentation/v2/#create-a-new-droplet" target="_blank"><code class="inline-code">/v2/droplets</code> endpoint</a> to create our new droplet. Let's write some <a class="fancy-link" href="https://nodejs.org" target="_blank">Node.js</a> code to automate our droplet creation. First, let's install some standard libraries we'll need for making network requests.</p><pre class="code-container"><code class="block-code">yarn add node-fetch</code></pre><p class="content-text">Next, let's write a quick set of functions to create our SSH fingerprint.</p><pre class="code-container"><code class="block-code">const crypto = require('crypto')<br><br>// compute MD5 fingerprint from SSH public key<br>const fingerprint = (pub) =&gt; {<br>    const pubre = /^(ssh-[dr]s[as]\s+)|(\s+.+)|\n/g<br>    const cleanpub = pub.replace(pubre, '')<br>    const pubbuffer = Buffer.from(cleanpub, 'base64')<br>    const key = hash(pubbuffer)<br>    return colons(key)<br>}<br><br>// compute MD5 hash<br>const hash = (s) =&gt; {<br>    return crypto.createHash('md5').update(s).digest('hex')<br>}<br><br>// add colons, 'hello' =&gt; 'he:ll:o'<br>const colons = (s) =&gt; {<br>    return s.replace(/(.{2})(?=.)/g, '&#36;1:')<br>}</code></pre><p class="content-text">Finally, let's write a simple function to create a droplet using our API token.</p><pre class="code-container"><code class="block-code">const fs = require('fs')<br>const fetch = require('node-fetch')<br><br>const createDroplet = async () =&gt; {<br>    // set up authentication<br>    let token = '&lt;YOUR API TOKEN&gt;'<br>    let sshKey = fs.readFileSync('~/.ssh/id_rsa.pub').toString()<br><br>    // configure droplet<br>    let configs = {<br>        name: 'my-test-droplet',<br>        region: 'sfo2',<br>        size: 's-1vcpu-1gb',<br>        image: 'ubuntu-18-04-x64',<br>        ssh_keys: [`&#36;{fingerprint(sshKey)}`],<br>        backups: false,<br>        ipv6: false,<br>        user_data: null,<br>        private_networking: null,<br>        volumes: null,<br>        tags: []<br>    }<br><br>    // create droplet with DigitalOcean API v2<br>    let response = await fetch('https://api.digitalocean.com/v2/droplets', {<br>        method: 'POST',<br>        headers: {<br>            'Content-Type': 'application/json',<br>            'Authorization': `Bearer &#36;{token}`<br>        },<br>        body: JSON.stringify(configs)<br>    })<br>    let data = await response.json()<br><br>    // report creation result<br>    if (data.droplet !== undefined) {<br>        console.log(`Created droplet: &#36;{data.droplet.id}`)<br>    } else {<br>        console.error('Could not create droplet')<br>    }<br>}</code></pre><p class="content-text">Great! Now when we create a droplet using <code class="inline-code">createDroplet()</code>, we get the following result.</p><pre class="code-container"><code class="block-code">Created droplet: my-test-droplet</code></pre><p class="content-text">Next, we'll want to SSH into our droplet. When a new droplet is created, it's starts in the <code class="inline-code">NEW</code> state. This means that the droplet is spinning up and is configuring itself. Once the droplet moves to the <code class="inline-code">ACTIVE</code> state, it will be assigned an IPv4 address and then we can SSH in using the SSH key-pair on our machine. In the first few lines of the <code class="inline-code">createDroplet()</code> function we specify our SSH public key as <code class="inline-code">&#126;/.ssh/id&#95;rsa.pub</code>.</p><p class="content-text">To wait for our new droplet to become active, let's write some code to ping the <code class="inline-code">/v2/droplets</code> endpoint with a <code class="inline-code">GET</code> request to check the droplet status.</p><pre class="code-container"><code class="block-code">// wait for the droplet to become active<br>const waitForDroplet = async (id) =&gt; {<br>    let done = false<br>    let token = '&lt;YOUR API TOKEN&gt;'<br>    let droplet = null<br>    while (!done) {<br>        droplet = await inspectDroplet(id)<br>        if (droplet.status === 'active') {<br>            done = true<br>        }<br>    }<br>    return droplet<br>}<br><br>// inspect a droplet based on ID<br>const inspectDroplet = async (id) =&gt; {<br>    let result = {<br>        id: null,<br>        status: null,<br>        ip: null,<br>        error: null<br>    }<br>    let token = '&lt;YOUR API TOKEN&gt;'<br>    let response = await fetch(`https://api.digitalocean.com/v2/droplets/&#36;{id}`, {<br>        headers: {<br>            'Content-Type': 'application/json',<br>            'Authorization': `Bearer &#36;{token}`<br>        }<br>    })<br>    let data = await response.json()<br>    if (data.droplet === undefined) {<br>        result.error = data.message<br>        return result<br>    }<br>    result.id = data.droplet.id<br>    result.status = data.droplet.status<br>    if (result.status === 'active') {<br>        result.ip = data.droplet.networks.v4.filter(ip =&gt; ip.type === 'public')[0].ip_address<br>    }<br>    return result<br>}</code></pre><p class="content-text">Cool! Now, let's add the following lines to the end of <code class="inline-code">createDroplet()</code> so we print our droplet's metadata after it's been created.</p><pre class="code-container"><code class="block-code">droplet = await waitForDroplet(data.droplet.id)<br>console.log(`Status: &#36;{droplet.status}`)<br>console.log(`ID: &#36;{droplet.id}`)<br>console.log(`IP address: &#36;{droplet.ip}`)</code></pre><p class="content-text">Now when when our code prints out the new droplet's IP address, we can SSH in!</p><br><h4 class="content-subtitle">Being a power user with the DigitalOcean CLI</h4><p class="content-text">The <a class="fancy-link" href="https://developers.digitalocean.com/documentation/v2/" target="_blank">DigitalOcean API</a> is powerful when you're creating programs to provision and tear down infrastructure, but what if we wanted to create a droplet quickly from the command line? DigitalOcean also has a CLI tool, <a class="fancy-link" href="https://github.com/digitalocean/doctl" target="_blank">called <code class="inline-code">doctl</code></a> (short for <i>DO control</i>), for interacting with DigitalOcean products. Let's see what it takes to create a droplet using <code class="inline-code">doctl</code> and Bash.</p><p class="content-text">To get started, let's install <code class="inline-code">doctl</code> via <a class="fancy-link" href="https://brew.sh" target="_blank">Homebrew</a>. If you don't use Homebrew, there are other installation options available in its <a class="fancy-link" href="https://github.com/digitalocean/doctl" target="_blank">GitHub repository</a>.</p><pre class="code-container"><code class="block-code">brew install doctl</code></pre><p class="content-text">In order for <code class="inline-code">doctl</code> to be authenticated against our DigitalOcean account, we need to use our <a class="fancy-link" href="https://cloud.digitalocean.com/account/api/tokens" target="_blank">authentication token</a> from before with <code class="inline-code">doctl auth</code>.</p><pre class="code-container"><code class="block-code">doctl auth init</code></pre><p class="content-text">Now for the code. First, we create our SSH fingerprint, same as before.</p><pre class="code-container"><code class="block-code">fingerprint="&#36;(ssh-keygen -E md5 -lf ~/.ssh/id_rsa.pub | awk '{print &#36;2}' | cut -c 5-)"</code></pre><p class="content-text">Then, we use <code class="inline-code">doctl compute droplet create</code> to create a new droplet.</p><pre class="code-container"><code class="block-code">doctl compute droplet create 'my-test-droplet' \<br>    --size s-1vcpu-1gb --image ubuntu-18-04-x64 \<br>    --region sfo2 \<br>    --format ID \<br>    --no-header \<br>    --ssh-keys "&#36;fingerprint"</code></pre><p class="content-text">Finally, let's again wait for the droplet to become active. Let's write this in a way so if we need to create multiple droplets later we wait for them <i>all</i> to become active.</p><pre class="code-container"><code class="block-code">complete=0<br>while [[ complete -eq 0 ]] ; do<br>    complete=1<br>    ran=0<br>    statuses=( `doctl compute droplet list --no-header --format "Status"` )<br>    for status in "&#36;{statuses[@]}" ; do<br>        if [[ "&#36;status" != active ]] ; then complete=0 ; fi<br>        ran=1<br>    done<br>    if [[ &#36;ran -eq 0 ]] ; then complete=0 ; fi<br>done</code></pre><p class="content-text">Great! As you can see, both <code class="inline-code">doctl</code> and and the DigitalOcean API allow us to rapidly create droplets.</p><br><h4 class="content-subtitle">Spinning up a fleet of DigitalOcean droplets</h4><p class="content-text">What if we wanted to spin up 10 droplets and kick off a job on each of them? Let's see how we could accomplish this with <code class="inline-code">doctl</code>.</p><p class="content-text">First, let's write a Bash function to create <code class="inline-code">x</code> number of droplets (with default of 10).</p><pre class="code-container"><code class="block-code">function create {<br>    fingerprint="&#36;(ssh-keygen -E md5 -lf ~/.ssh/id_rsa.pub | awk '{print &#36;2}' | cut -c 5-)"<br>    for index in &#36;(seq 1 &#36;{1:-10}) ; do<br>        echo "Creating droplet-&#36;index"<br>        continue<br>        doctl compute droplet create "droplet-&#36;index" \<br>            --size s-1vcpu-1gb --image ubuntu-18-04-x64 \<br>            --region sfo2 \<br>            --format ID \<br>            --no-header \<br>            --ssh-keys "&#36;fingerprint"<br>    done<br>    wait<br>}</code></pre><p class="content-text">Next, we'll use our same code from above as our <code class="inline-code">wait</code> function.</p><pre class="code-container"><code class="block-code">function wait {<br>    complete=0<br>    while [[ complete -eq 0 ]] ; do<br>        complete=1<br>        ran=0<br>        statuses=( `doctl compute droplet list --no-header --format "Status"` )<br>        for status in "&#36;{statuses[@]}" ; do<br>            if [[ "&#36;status" != active ]] ; then complete=0 ; fi<br>            ran=1<br>        done<br>        if [[ &#36;ran -eq 0 ]] ; then complete=0 ; fi<br>    done<br>}</code></pre><p class="content-text">Finally, let's write one last function to kick off our job on each droplet.</p><pre class="code-container"><code class="block-code">function run {<br>    for index in &#36;(seq 1 &#36;{1:-10}) ; do<br>        echo -n "Starting droplet-&#36;index"<br>        <br>        doctl compute ssh "droplet-&#36;index" --ssh-port 22 &lt;&lt;EndSSH &gt; /dev/null 2&gt;&1<br>cat &lt;&lt; EndOfScript &gt; run.sh<br>telnet towel.blinkenlights.nl<br>EndOfScript<br>EndSSH<br>        doctl compute ssh "droplet-&#36;index" --ssh-command "\<br>            chmod +x ~/run.sh ; \<br>            echo '~/run.sh &' | script 'screen -' \<br>        " &gt; /dev/null 2&gt;&1<br>        echo "Started the job on droplet-&#36;index"<br>    done<br>}</code></pre><p class="content-text">We could also write some code to check if the job has completed and then tear down the droplet, but I'm going to err on that being outside the scope of this article.</p><br><h4 class="content-subtitle">Conclusion</h4><p class="content-text">As we've demonstrated, DigitalOcean is a powerful competitor in the IaaS and PaaS space. It may not have as extensive a product lineup as AWS, GCP, and Azure, but they do have robust automation tooling in the form of <a class="fancy-link" href="https://github.com/digitalocean/doctl" target="_blank"><code class="inline-code">doctl</code></a> and the <a class="fancy-link" href="https://developers.digitalocean.com/documentation/v2/" target="_blank">DigitalOcean API</a>, and the products they do have are straightforward and easy-to-use. For instance, have you ever tried setting up an AWS or GCP project <i>from scratch</i> with properly configured IAM roles and API and CLI support? Sometimes just installing <a class="fancy-link" href="https://cloud.google.com/sdk/gcloud" target="_blank"><code class="inline-code">gcloud</code></a> can be a pain. DigitalOcean is lightweight enough to get rolling within minutes, and that's why I continue using it for my projects.</p><p class="content-text">If you want a complete copy of all the code from this post, check out <a class="fancy-link" href="https://github.com/wcarhart/willcarh.art-snippets/tree/master/spinning-up-a-fleet-of-digitalocean-droplets" target="_blank">this repository</a>. Until next time, see you on the ocean.</p><br><p class="content-text centered-text">🦉</p>
</div>
<div class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<p id="cover-credit">Artwork by <a class="fancy-link" href="https://stock.adobe.com/contributor/200769316/serge-b" target="_blank">serge-b</a></p>
</div>
<div id="blog-navigation-container" class="animate__animated animated_faster animate__fadeIn animate__delay-4s">
	<div class="row">
		<div class="col-md-1"></div>
		<div id="blog-navigation-back" class="col-md-4 blog-navigation-chunk">
			<h3><span class="show-more">⟵</span> Back</h3>
			<p class="navigation-detail-text content-text">Go back to the blog</p>
		</div>
		<div class="col-md-2"></div>
		<div id="blog-navigation-next" class="col-md-4 blog-navigation-chunk">
			<h3>Read More <span class="show-more">⟶</span></h3>
			<p class="navigation-detail-text content-text">On Failure</p>
		</div>
		<div class="col-md-1"></div>
	</div>
</div>
<div class="spacer-small"></div>
			</div>
			<div class="spacer"></div>

			<div id="credits" class="row">
	<a id="footer-github-icon" href="https://github.com/wcarhart" target="_blank"><i class="fab fa-github"></i></a>
	<a id="footer-stackoverflow-icon" href="https://stackoverflow.com/users/6246128/wcarhart" target="_blank"><i class="fab fa-stack-overflow" data-fa-transform="left-2"></i></a>
	<a id="footer-linkedin-icon" href="https://linkedin.com/in/willcarhart" target="_blank"><i class="fab fa-linkedin" data-fa-transform="left-2"></i></a>
	<a id="footer-facebook-icon" href="../blog/why-i-deleted-my-facebook.html"><i class="fab fa-facebook-f" data-fa-transform="left-4"></i></a>
	<div style="text-align:center"><a class="fancy-link" href="../etc.html#license">&copy;&nbsp; Will Carhart <span id="year"></span></a></div>
</div>
			<div class="spacer-small"></div>
		</div>

		<!-- logo -->
		<a id="logo-container" href="../index.html">
	<img id="logo" alt="willcarh.art logo" src="../ico/android-chrome-512x512.png">
</a>

		<!-- dark mode toggle -->
		<div id="dark-mode-toggle-container">
	<button id="dark-mode-toggle"></button>
</div>
	</body>
</html>